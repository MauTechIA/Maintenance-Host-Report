<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Host Report</title>
    <!-- Registro del Service Worker (soporte offline) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('./sw.js')
                    .then(function (reg) { console.log('[SW] Registrado:', reg.scope); })
                    .catch(function (err) { console.warn('[SW] Error al registrar:', err); });
            });
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet.js para mapa interactivo -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <!-- togeojson para convertir KML a GeoJSON -->
    <script src="https://cdn.jsdelivr.net/npm/@mapbox/togeojson@0.16.2/togeojson.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #f5f5f5;
            --card: #ffffff;
            --muted: #6b7280;
            --primary: #374151;
            --accent: #475569;
            --border: #e5e7eb;
            --shadow: 0 6px 18px rgba(15, 23, 36, 0.04);
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            background: var(--bg);
            color: #0f1724;
            margin: 0;
            padding: 28px;
        }

        .report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 18px;
            padding: 12px 18px;
            background: var(--card);
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .report-header .left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .report-header img {
            height: 140px;
            width: auto;
            object-fit: contain;
            border-radius: 6px;
        }

        .report-header .meta {
            text-align: right;
            font-size: 13px;
            color: var(--muted);
            line-height: 1.1
        }

        .report-header .meta .title {
            font-size: 15px;
            font-weight: 600;
            color: #0f1724
        }

        #main-title {
            text-align: center;
            margin: 20px 0;
            font-weight: 700;
            color: #0f1724
        }

        /* Form card */
        #report-form {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            max-width: 760px;
            margin: 0 auto;
        }

        h3 {
            font-size: 15px;
            margin-top: 18px;
            margin-bottom: 8px;
            color: #0f1724;
            border-bottom: none;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #0f1724
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #dbe9fb;
            background: #fbfdff;
            box-sizing: border-box;
            font-size: 14px;
            color: #0f1724
        }

        textarea {
            min-height: 84px;
            resize: vertical
        }

        input[type="checkbox"] {
            transform: scale(1.05);
            margin-right: 8px
        }

        /* Item details */
        .item-details {
            background: #fcfeff;
            border: 1px solid #eef6ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px
        }

        .item-details small {
            color: var(--muted)
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600
        }

        input[type="submit"],
        .btn-primary {
            background: var(--primary);
            color: #fff
        }

        .btn-ghost {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--border)
        }

        .item-done,
        .item-update {
            padding: 6px 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600
        }

        .item-done {
            background: linear-gradient(180deg, #6b7280, #4b5563);
            color: #fff
        }

        .item-update {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--border)
        }

        .item-duplicate {
            background: var(--accent);
            color: #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: none;
            cursor: pointer
        }

        .item-clear {
            float: right;
            margin-left: 12px
        }

        /* Author select */
        #report-authors-select {
            max-width: 420px
        }

        /* PDF preview */
        #pdf-preview-container {
            position: fixed;
            right: 18px;
            top: 120px;
            width: 36%;
            height: 68%;
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: none;
            z-index: 9999;
            padding: 8px;
            border-radius: 8px;
            overflow: hidden
        }

        #pdf-preview-actions {
            height: 40px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            align-items: center
        }

        #pdf-preview-frame {
            width: 100%;
            height: calc(100% - 48px);
            border: none;
            display: block
        }

        #pdf-preview-close {
            background: #ef4444;
            color: #fff;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer
        }

        #pdf-download-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer
        }

        /* Spinner overlay inside preview */
        #pdf-spinner {
            position: absolute;
            left: 8px;
            right: 8px;
            top: 56px;
            bottom: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.85);
            z-index: 12;
            border-radius: 6px
        }

        .spinner {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 5px solid #e6eef9;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Admin Panel */
        #admin-panel {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin: 20px auto;
            max-width: 900px;
        }

        #admin-panel h2 {
            margin-top: 0;
            color: #0f1724;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        #admin-reports-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        #admin-reports-table th,
        #admin-reports-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        #admin-reports-table th {
            background: #f9fafb;
            font-weight: 600;
            color: var(--muted);
        }

        #admin-reports-table tr:hover {
            background: #f3f4f6;
        }

        .admin-btn-view {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .admin-btn-view:hover {
            text-decoration: underline;
        }

        /* Responsive behavior: move preview to bottom on small screens */
        @media (max-width:1000px) {
            #pdf-preview-container {
                position: fixed;
                left: 12px;
                right: 12px;
                bottom: 12px;
                top: auto;
                width: auto;
                height: 40%;
            }

            #report-header,
            #main-title {
                padding-right: 12px
            }

            #report-form {
                max-width: 100%;
                padding-bottom: 120px
            }
        }

        /* Mobile adjustments for sidebar */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .main-content {
                padding: 20px;
            }

            #pdf-preview-container {
                left: 10px;
                right: 10px;
            }
        }

        /* Print rules */
        @media print {
            body {
                padding: 10mm
            }

            .report-header {
                page-break-after: avoid
            }

            #pdf-preview-container {
                display: none
            }
        }

        /* Bot√≥n fijo para limpiar todo (esquina inferior derecha) */
        .clear-all-btn {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 10050;
            background: #ef4444;
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 700;
            box-shadow: 0 8px 20px rgba(15, 23, 36, 0.12);
            cursor: pointer;
            display: inline-block
        }

        .clear-all-btn:active {
            transform: translateY(1px)
        }

        /* Ajustes responsive: en pantallas peque√±as centrar y usar safe-area */
        @media (max-width:640px) {
            .clear-all-btn {
                left: 12px;
                right: 12px;
                bottom: calc(env(safe-area-inset-bottom, 12px) + 12px);
                width: auto;
                display: block;
                margin: 0 auto;
                border-radius: 12px;
                text-align: center
            }
        }

        /* Modal del mapa */
        #map-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        #map-modal.open {
            display: flex;
        }

        #map-modal-content {
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            height: 90%;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            z-index: 10001;
            position: relative;
        }

        #map-modal-header {
            padding: 16px 20px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        #map-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #0f1724;
            margin: 0;
        }

        #map-modal-close {
            background: transparent;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #9ca3af;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #map-modal-close:hover {
            color: #0f1724;
            background: #f3f4f6;
            border-radius: 6px;
        }

        #map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            border-radius: 0 0 0 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #map-info {
            padding: 12px 16px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            font-size: 13px;
            color: #374151;
            flex-shrink: 0;
            min-height: 60px;
            display: flex;
            align-items: center;
        }

        #map-modal-actions {
            padding: 16px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            flex-shrink: 0;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
        }

        #map-modal-confirm {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            z-index: 10002;
            position: relative;
        }

        #map-modal-confirm:hover {
            background: #1f2937;
            box-shadow: 0 4px 12px rgba(31, 41, 55, 0.3);
        }

        #map-modal-confirm:active {
            transform: translateY(1px);
        }

        #map-gps-btn {
            background: #fff;
            color: #0f766e;
            border: 2px solid #0f766e;
            padding: 11px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 7px;
            transition: all 0.2s ease;
            z-index: 10002;
            position: relative;
        }

        #map-gps-btn:hover {
            background: #0f766e;
            color: #fff;
        }

        #map-gps-btn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        /* Estilo para etiquetas del mapa en PDF */
        .map-label-icon {
            background: #d9534f;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-size: 12px;
        }

        /* Evidencias fotogr√°ficas */
        .photo-upload-area {
            margin: 8px 0;
        }
        .photo-upload-btns {
            display: flex;
            gap: 8px;
            max-width: 420px;
            flex-wrap: wrap;
        }
        .photo-upload-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            background: #f0f6ff;
            border: 2px dashed #93c5fd;
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 13px;
            color: #1e40af;
            transition: background 0.2s, border-color 0.2s;
            flex: 1;
            min-width: 140px;
            box-sizing: border-box;
            text-align: center;
        }
        .photo-upload-label:hover {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        .photo-camera-label {
            background: #f0fdf4;
            border-color: #6ee7b7;
            color: #065f46;
        }
        .photo-camera-label:hover {
            background: #dcfce7;
            border-color: #34d399;
        }
        .photo-upload-input {
            display: none;
        }
        .photo-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            max-width: 420px;
        }
        .photo-thumb-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
        }
        .photo-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            display: block;
        }
        .photo-thumb-remove {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 13px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        /* Login Modal - Aviation Theme */
        /* ===== LOGIN MODAL ‚Äî SPLIT SCREEN ===== */
        #login-modal {
            display: flex;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 20000;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        /* LEFT PANEL ‚Äî Image */
        #login-panel-left {
            flex: 1 1 55%;
            position: relative;
            background: url('Im√°genes/Whisky_1.jpg') center center / cover no-repeat;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            overflow: hidden;
        }
        #login-panel-left::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                to bottom,
                rgba(0,0,0,0.15) 0%,
                rgba(5,15,40,0.55) 60%,
                rgba(5,15,40,0.85) 100%
            );
        }
        #login-brand {
            position: relative;
            z-index: 1;
            padding: 40px 48px;
            color: #fff;
        }
        #login-brand .brand-badge {
            display: inline-block;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            padding: 5px 14px;
            border-radius: 20px;
            margin-bottom: 18px;
        }
        #login-brand h1 {
            font-size: clamp(22px, 3vw, 34px);
            font-weight: 800;
            line-height: 1.2;
            margin: 0 0 12px 0;
            text-shadow: 0 2px 12px rgba(0,0,0,0.4);
        }
        #login-brand p {
            font-size: 14px;
            color: rgba(255,255,255,0.75);
            margin: 0 0 28px 0;
            line-height: 1.5;
        }
        #login-brand .brand-footer {
            font-size: 11px;
            color: rgba(255,255,255,0.45);
            letter-spacing: 1px;
            border-top: 1px solid rgba(255,255,255,0.15);
            padding-top: 18px;
        }

        /* RIGHT PANEL ‚Äî Form */
        #login-box {
            flex: 0 0 420px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 52px 48px;
            box-shadow: -8px 0 40px rgba(0,0,0,0.18);
            position: relative;
            overflow-y: auto;
        }
        #login-box::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 4px; height: 100%;
            background: linear-gradient(180deg, #007acc, #0055a5, #001f4d);
        }
        #login-icon {
            font-size: 38px;
            margin-bottom: 10px;
            display: block;
            line-height: 1;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%   { transform: translateY(0px); }
            50%  { transform: translateY(-8px); }
            100% { transform: translateY(0px); }
        }
        #login-box .login-eyebrow {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #007acc;
            margin-bottom: 6px;
        }
        #login-box h2 {
            margin: 0 0 6px 0;
            color: #0f172a;
            font-size: 26px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        #login-box > p {
            color: #64748b;
            font-size: 13px;
            margin: 0 0 32px 0;
            line-height: 1.5;
        }
        .input-group {
            position: relative;
            margin-bottom: 18px;
            text-align: left;
        }
        .input-group label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        #login-box input {
            width: 100%;
            padding: 13px 16px;
            border: 1.5px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            background: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
            box-sizing: border-box;
            color: #0f172a;
        }
        #login-box input::placeholder { color: #94a3b8; }
        #login-box input:focus {
            border-color: #007acc;
            box-shadow: 0 0 0 4px rgba(0, 122, 204, 0.12);
        }
        #login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #0055a5, #007acc);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.15s, box-shadow 0.2s;
            margin-top: 6px;
            letter-spacing: 0.3px;
            box-shadow: 0 4px 18px rgba(0, 85, 165, 0.35);
        }
        #login-btn:hover {
            opacity: 0.92;
            box-shadow: 0 6px 22px rgba(0, 85, 165, 0.45);
        }
        #login-btn:active { transform: scale(0.98); }
        #login-error {
            background: #fef2f2;
            color: #991b1b;
            padding: 11px 14px;
            border-radius: 8px;
            margin-top: 14px;
            font-size: 13px;
            display: none;
            border: 1px solid #fecaca;
        }
        .login-footer-note {
            margin-top: 28px;
            font-size: 11px;
            color: #94a3b8;
            text-align: center;
            border-top: 1px solid #e2e8f0;
            padding-top: 20px;
            line-height: 1.6;
        }

        /* Responsive: stack on small screens */
        @media (max-width: 700px) {
            #login-modal { flex-direction: column; }
            #login-panel-left { flex: 0 0 220px; }
            #login-box { flex: 1 1 auto; padding: 36px 28px; }
        }

        /* Hide main content initially */
        body.loading-auth>*:not(#login-modal) {
            filter: blur(5px);
        }

        #user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            z-index: 100;
            display: none;
            align-items: center;
            gap: 8px;
        }

        #logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: var(--card);
            border-right: 1px solid var(--border);
            box-shadow: var(--shadow);
            z-index: 50;
            overflow-y: auto;
        }

        .sidebar-tabs {
            display: flex;
            flex-direction: column;
            padding: 20px 0;
        }

        .sidebar-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            text-align: left;
            font-size: 16px;
            font-weight: 600;
            color: var(--muted);
            border-left: 4px solid transparent;
            transition: all 0.2s ease;
        }

        .sidebar-tab:hover {
            background: #f9fafb;
            color: #0f1724;
        }

        .sidebar-tab.active {
            background: #e5e7eb;
            color: #0f1724;
            border-left-color: var(--primary);
        }

        /* Main content area */
        .main-content {
            margin-left: 280px;
            padding: 28px;
            min-height: 100vh;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Sidebar hidden state */
        body.sidebar-hidden .sidebar {
            display: none;
        }
        body.sidebar-hidden .main-content {
            margin-left: 0;
        }
        #menu-toggle-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 200;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 14px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: var(--shadow);
            line-height: 1;
        }
        body.sidebar-hidden #menu-toggle-btn {
            display: block;
        }

        /* Responsive sidebar */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .sidebar-tabs {
                flex-direction: row;
                padding: 10px;
                overflow-x: auto;
            }

            .sidebar-tab {
                padding: 10px 15px;
                white-space: nowrap;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }
        }
        /* Indicador Offline / Sincronizaci√≥n pendiente */
        #offline-banner {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0;
            background: #f59e0b;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            padding: 8px 16px;
            z-index: 99999;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #offline-banner.offline { background: #ef4444; }
        #offline-banner.syncing { background: #3b82f6; }
        #offline-banner.synced  { background: #22c55e; }
        #pending-badge {
            display: none;
            position: fixed;
            bottom: 70px;
            right: 18px;
            background: #f59e0b;
            color: #fff;
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 700;
            z-index: 10060;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: default;
        }
    </style>
</head>

<body>

    <!-- Banner de estado de conexi√≥n -->
    <div id="offline-banner"></div>
    <!-- Badge de reportes pendientes de sincronizar -->
    <div id="pending-badge"></div>

    <!-- Login Modal -->
    <div id="login-modal">

        <!-- Left: Background image + branding -->
        <div id="login-panel-left">
            <div id="login-brand">
                <div class="brand-badge">‚úà AIFA ¬∑ Seguridad Operacional</div>
                <h1>Formato de Revisi√≥n del √Årea de Movimiento</h1>
                <p>Sistema institucional de reportes de mantenimiento y seguridad aeroportuaria. Acceso exclusivo para personal autorizado.</p>
                <div class="brand-footer">AIFA-DO-SSO-GSO-MHR-F1 &nbsp;¬∑&nbsp; Aeropuerto Internacional Felipe √Ångeles</div>
            </div>
        </div>

        <!-- Right: Login form -->
        <div id="login-box">
            <div id="login-icon">‚úàÔ∏è</div>
            <div class="login-eyebrow">Portal de Acceso</div>
            <h2>Bienvenido a Bordo</h2>
            <p>Ingrese sus credenciales institucionales para continuar.</p>

            <div class="input-group">
                <label>Correo Institucional</label>
                <input type="email" id="login-email" placeholder="nombre@aeropuerto.com" autocomplete="email" />
            </div>

            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
            </div>

            <button id="login-btn">Iniciar Sesi√≥n</button>
            <div id="login-error"></div>

            <div class="login-footer-note">
                üîí Acceso restringido a personal autorizado<br>
                SSO Runway Report System
            </div>
        </div>

    </div>

    <!-- Menu toggle button (visible when sidebar is hidden) -->
    <button id="menu-toggle-btn" title="Mostrar men√∫">‚ò∞</button>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-tabs">
            <button class="sidebar-tab active" data-tab="revision">üìã Formato de Revisi√≥n</button>
            <button class="sidebar-tab" data-tab="historial">üìö Historial de Reportes</button>
            <button class="sidebar-tab" data-tab="estadistica">üìä Estad√≠sticas</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <!-- User Info (Top Right) -->
        <div id="user-info">
            <span id="user-email"></span>
            <span id="user-role"
                style="background:#e5e7eb; padding:2px 6px; border-radius:4px; font-weight:bold;"></span>
            <button id="logout-btn">Salir</button>
        </div>

        <header class="report-header">
            <div class="left">
                <img src="logo.png" alt="Logo">
            </div>
            <div class="meta">
                <div class="title">Direcci√≥n de Operaci√≥n</div>
                <div>Subdirecci√≥n de Seguridad Operacional</div>
                <div>Gerencia de Seguridad Operacional</div>
                <div>
                    <span id="report-date">--/--/----</span>
                    <small id="report-utc" style="margin-left:10px; color:#6b7280; font-size:13px;">UTC --:--:--</small>
                </div>
                <div>AIFA-DO-SSO-GSO-MHR-F1</div>
                <div style="margin-top:8px; text-align:right;">
                    <button id="clear-saved-btn" class="btn-ghost" style="padding:6px 10px; border-radius:6px;">Limpiar
                        guardado</button>
                </div>
            </div>
        </header>

        <h1 id="main-title">Formato de Revisi√≥n del √Årea de Movimiento</h1>

        <!-- Formato de Revisi√≥n Section -->
        <div id="revision-section" class="content-section active">

            <form id="report-form" action="#" method="get">

                <h3>‚ö†Ô∏è Tipo de Inspecci√≥n</h3>

                <input type="checkbox" id="ins_primaria" name="tipo_inspeccion" value="Primaria">
                <label for="ins_primaria">Primaria</label><br>

                <input type="checkbox" id="ins_secundaria" name="tipo_inspeccion" value="Secundaria">
                <label for="ins_secundaria">Secundaria</label><br>

                <div id="turno-section" style="display:none; margin-top:8px;">
                    <h3>Turno</h3>
                    <input type="radio" id="turno_diurno" name="turno" value="Diurna">
                    <label for="turno_diurno">Diurno</label><br>
                    <input type="radio" id="turno_nocturno" name="turno" value="Nocturna">
                    <label for="turno_nocturno">Nocturno</label><br>
                </div>

                <h3>üßë‚Äç‚úàÔ∏è Responsable(s) que elaboran el reporte</h3>
                <!-- Select para Responsable: reemplaza la lista de botones -->
                <select id="report-authors-select" name="report_authors" title="Seleccionar Responsable">
                    <option value="">-- Seleccionar Responsable --</option>
                    <option value="Miguel M√©ndez">Miguel M√©ndez</option>
                    <option value="Juan Carlos Cruz">Juan Carlos Cruz</option>
                    <option value="Baltazar Alarc√≥n">Baltazar Alarc√≥n</option>
                    <option value="Jorge Soria">Jorge Soria</option>
                    <option value="Israel Montes Sarabia">Israel Montes Sarabia</option>
                    <option value="Daniel Cuevas">Daniel Cuevas</option>
                    <option value="Mauricio Neos">Mauricio Neos</option>
                    <option value="Isaac L√≥pez">Isaac L√≥pez</option>
                    <option value="Mauro Hern√°ndez">Mauro Hern√°ndez</option>
                    <option value="Daniel Mej√≠a">Daniel Mej√≠a</option>
                </select>
                <button type="button" id="report-authors-reset" style="display:none; margin-top:6px;">Cambiar
                    responsable</button>

                <h3>ü™™ Cargo</h3>
                <select id="report-role" name="report_role" title="Seleccionar Cargo">
                    <option value="Inspector">Oficial de Operaciones Aeroportuarias</option>
                    <option value="Jefe de √Årea">Gerente de MDS</option>
                    <option value="Supervisor">Supervisor de MDS</option>
                    <option value="Coordinador">Coordinador de MDS</option>
                    <option value="Coordinador">Coordinador de Fauna</option>
                    <option value="Otro">Otro</option>
                </select>
                <button type="button" id="report-role-reset" style="display:none; margin-top:6px;">Cambiar
                    cargo</button>
                <input type="text" id="report-role-other" name="report_role_other" placeholder="Especifique otro cargo"
                    style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />

                <h3>üîßüìöüìã Item:</h3>
                <!-- Per-item Done/Update buttons will appear next to each item -->

                <input type="checkbox" id="tipo_area_movimiento" name="tipo_reporte" value="√Årea de Movimiento">
                <label for="tipo_area_movimiento">√Årea de Movimiento</label>
                <button type="button" id="done_tipo_area_movimiento" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_area_movimiento" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_area_movimiento"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_area_movimiento][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_area_movimiento" name="details[tipo_area_movimiento][hallazgo]">
                            <option value="">--</option>
                            <option>Grietas/Fisuras</option>
                            <option>Oquedades</option>
                            <option>F.O.D</option>
                            <option>Baches</option>
                            <option>Ondulaciones</option>
                            <option>Caucho</option>
                            <option>Cuerpos de Agua</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_area_movimiento"
                            name="details[tipo_area_movimiento][hallazgo_other]" placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n:
                        <select class="condicion-select" name="details[tipo_area_movimiento][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select>
                    </label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_area_movimiento][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_area_movimiento][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text"
                            name="details[tipo_area_movimiento][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_franjas" name="tipo_reporte"
                    value="Franjas de seguridad (Pistas y Rodados)">
                <label for="tipo_franjas">Franjas de seguridad</label>
                <button type="button" id="done_tipo_franjas" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_franjas" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_franjas"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_franjas][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_franjas" name="details[tipo_franjas][hallazgo]">
                            <option value="">--</option>
                            <option>Drenaje/Construcci√≥n</option>
                            <option>Registros</option>
                            <option>Vialidades</option>
                            <option>Objetos</option>
                            <option>Bases Fr√°giles</option>
                            <option>Surcos</option>
                            <option>Mont√≠culos/Erosiones</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_franjas" name="details[tipo_franjas][hallazgo_other]"
                            placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_franjas][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_franjas][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_franjas][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_franjas][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_iluminacion" name="tipo_reporte" value="Iluminaci√≥n">
                <label for="tipo_iluminacion">Iluminaci√≥n</label>
                <button type="button" id="done_tipo_iluminacion" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_iluminacion" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_iluminacion"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_iluminacion][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_iluminacion" name="details[tipo_iluminacion][hallazgo]">
                            <option value="">--</option>
                            <option>Faltante/Donado</option>
                            <option>Inoperativo</option>
                            <option>Obscuro/Sucio</option>
                            <option>Mal Direccionado</option>
                            <option>Ajuste</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_iluminacion"
                            name="details[tipo_iluminacion][hallazgo_other]" placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_iluminacion][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_iluminacion][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_iluminacion][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_iluminacion][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_marcas" name="tipo_reporte" value="Marcas y Se√±al√≠stica">
                <label for="tipo_marcas">Marcas y Se√±ales</label>
                <button type="button" id="done_tipo_marcas" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_marcas" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_marcas"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_marcas][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_marcas" name="details[tipo_marcas][hallazgo]">
                            <option value="">--</option>
                            <option>Visibles</option>
                            <option>Desgastadas</option>
                            <option>En Norma</option>
                            <option>Letrero Da√±ado</option>
                            <option>Marcas de Parada</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_marcas" name="details[tipo_marcas][hallazgo_other]"
                            placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_marcas][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_marcas][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_marcas][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_marcas][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_ayudas" name="tipo_reporte" value="Ayudas a la Navegaci√≥n">
                <label for="tipo_ayudas">Ayudas a la Navegaci√≥n</label>
                <button type="button" id="done_tipo_ayudas" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_ayudas" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_ayudas"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_ayudas][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_ayudas" name="details[tipo_ayudas][hallazgo]">
                            <option value="">--</option>
                            <option>Luces PAPI</option>
                            <option>Conos de Viento</option>
                            <option>VOR</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_ayudas" name="details[tipo_ayudas][hallazgo_other]"
                            placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_ayudas][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_ayudas][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_ayudas][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_ayudas][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_obstaculos" name="tipo_reporte" value="Obst√°culos">
                <label for="tipo_obstaculos">Obst√°culos</label>
                <button type="button" id="done_tipo_obstaculos" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_obstaculos" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_obstaculos"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_obstaculos][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_obstaculos" name="details[tipo_obstaculos][hallazgo]">
                            <option value="">--</option>
                            <option>Luces de Obstrucci√≥n</option>
                            <option>√Årboles</option>
                            <option>Gr√∫as</option>
                            <option>Torres</option>
                            <option>Espectaculares</option>
                            <option>Edificios</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_obstaculos"
                            name="details[tipo_obstaculos][hallazgo_other]" placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_obstaculos][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_obstaculos][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_obstaculos][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_obstaculos][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_combustibles" name="tipo_reporte" value="Operaciones de Combustibles">
                <label for="tipo_combustibles">Operaciones de Combustibles</label>
                <button type="button" id="done_tipo_combustibles" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_combustibles" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_combustibles"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_combustibles][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_combustibles" name="details[tipo_combustibles][hallazgo]">
                            <option value="">--</option>
                            <option>Fuga/Derrame</option>
                            <option>Balizamiento(Toma de Combustible en Plataforma)</option>
                            <option>Extintores</option>
                            <option>Tierras F√≠sicas</option>
                            <option>Veh√≠culos/Posici√≥n</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_combustibles"
                            name="details[tipo_combustibles][hallazgo_other]" placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_combustibles][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_combustibles][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_combustibles][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_combustibles][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_construccion" name="tipo_reporte" value="Construcci√≥n">
                <label for="tipo_construccion">Construcci√≥n</label>
                <button type="button" id="done_tipo_construccion" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_construccion" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_construccion"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_construccion][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_construccion" name="details[tipo_construccion][hallazgo]">
                            <option value="">--</option>
                            <option>Balizamiento</option>
                            <option>Luces</option>
                            <option>Equipo</option>
                            <option>Personal</option>
                            <option>Plan de Seguridad</option>
                            <option>Uso de Pistas/Rodajes</option>
                            <option>Limpieza</option>
                            <option>FOD</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_construccion"
                            name="details[tipo_construccion][hallazgo_other]" placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_construccion][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_construccion][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_construccion][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_construccion][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_ssei" name="tipo_reporte" value="SSEI">
                <label for="tipo_ssei">SSEI</label>
                <button type="button" id="done_tipo_ssei" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_ssei" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_ssei"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_ssei][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_ssei" name="details[tipo_ssei][hallazgo]">
                            <option value="">--</option>
                            <option>Equipo Disponible</option>
                            <option>Comunicaciones</option>
                            <option>Personal Disponible</option>
                            <option>Alarma</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_ssei" name="details[tipo_ssei][hallazgo_other]"
                            placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_ssei][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_ssei][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_ssei][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_ssei][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_vehiculos" name="tipo_reporte" value="Veh√≠culos Terrestres">
                <label for="tipo_vehiculos">Veh√≠culos Terrestres</label>
                <button type="button" id="done_tipo_vehiculos" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_vehiculos" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_vehiculos"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_vehiculos][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_vehiculos" name="details[tipo_vehiculos][hallazgo]">
                            <option value="">--</option>
                            <option>Exceso de Velocidad</option>
                            <option>Comunicaciones</option>
                            <option>Procedimientos</option>
                            <option>Reglas</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_vehiculos"
                            name="details[tipo_vehiculos][hallazgo_other]" placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_vehiculos][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_vehiculos][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_vehiculos][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_vehiculos][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_fauna" name="tipo_reporte" value="Fauna">
                <label for="tipo_fauna">Control de Fauna</label>
                <button type="button" id="done_tipo_fauna" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_fauna" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_fauna"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_fauna][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_fauna" name="details[tipo_fauna][hallazgo]">
                            <option value="">--</option>
                            <option>Aves</option>
                            <option>Caninos</option>
                            <option>Reptiles</option>
                            <option>Fauna Terrestre</option>
                            <option>Plagas/Insectos</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_fauna" name="details[tipo_fauna][hallazgo_other]"
                            placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_fauna][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_fauna][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_fauna][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_fauna][codigo]"></label>
                </div>

                <input type="checkbox" id="tipo_proteccion" name="tipo_reporte" value="Protecci√≥n P√∫blica">
                <label for="tipo_proteccion">Protecci√≥n P√∫blica</label>
                <button type="button" id="done_tipo_proteccion" class="item-done"
                    style="display:none; margin-left:6px;">Done</button>
                <button type="button" id="update_tipo_proteccion" class="item-update"
                    style="display:none; margin-left:6px;">Update</button>
                <br>
                <div class="item-details" id="details_tipo_proteccion"
                    style="display:none; margin-left:18px; margin-bottom:10px;">
                    <label>Lugar: <input type="text" name="details[tipo_proteccion][lugar]"></label><br>
                    <label>Hallazgo:
                        <select id="hallazgo_tipo_proteccion" name="details[tipo_proteccion][hallazgo]">
                            <option value="">--</option>
                            <option>Personas NO Autorizadas</option>
                            <option>Veh√≠culos NO Autorizados</option>
                            <option>Abordadores Mec√°nicos</option>
                            <option>Otro</option>
                        </select>
                        <input type="text" id="hallazgo_other_tipo_proteccion"
                            name="details[tipo_proteccion][hallazgo_other]" placeholder="Especifique otro hallazgo"
                            style="display:none; margin-top:6px; max-width:420px; width:100%; padding:6px;" />
                    </label><br>
                    <label>Condici√≥n: <select class="condicion-select" name="details[tipo_proteccion][condicion]">
                            <option value="">--</option>
                            <option value="Satisfactorio">Satisfactorio</option>
                            <option value="No Satisfactorio">No Satisfactorio</option>
                            <option value="N/A">N/A</option>
                        </select></label><br>
                    <label>Observaciones:<br><textarea name="details[tipo_proteccion][observaciones]" rows="3"
                            style="width:100%; max-width:420px;"></textarea></label><br>
                    <label>Prioridad:
                        <select class="priority-select" name="details[tipo_proteccion][prioridad]">
                            <option value="">N/A</option>
                            <option value="1">Baja / No Urgente</option>
                            <option value="2">Media / Urgencia Moderada</option>
                            <option value="3">Alta / Muy Urgente</option>
                        </select>
                    </label><br>
                    <label>C√≥digo de Seguimiento: <input type="text" name="details[tipo_proteccion][codigo]"></label>
                </div>




                <input type="submit" value="Generar reporte">
            </form>

        </div> <!-- End revision-section -->

        <!-- Historial de Reportes Section -->
        <div id="historial-section" class="content-section">
            <h1>Historial de Reportes</h1>

            <!-- Admin Panel -->
            <div id="admin-panel" style="display:none;">
                <button id="refresh-admin-btn" class="btn btn-ghost" style="margin-bottom:10px;">üîÑ Actualizar
                    Lista</button>
                <table id="admin-reports-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Folio</th>
                            <th>Responsable</th>
                            <th>PDF</th>
                        </tr>
                    </thead>
                    <tbody id="admin-reports-list">
                        <!-- Rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div> <!-- End historial-section -->

        <!-- Estad√≠sticas Section -->
        <div id="estadistica-section" class="content-section">
            <h1>Estad√≠sticas de Reportes</h1>

            <!-- Estad√≠sticas Panel -->
            <div id="estadisticas-panel"
                style="background:var(--card); padding:20px; border-radius:12px; box-shadow:var(--shadow); margin:20px auto; max-width:1200px;">
                <h2>üìä Panel de Estad√≠sticas</h2>

                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    <!-- Estad√≠sticas principales -->
                    <div class="stat-card"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; font-size: 2.5em; font-weight: bold;" id="total-reports">0</h3>
                        <p style="margin: 0; font-size: 1.1em;">Total de Reportes</p>
                    </div>

                    <div class="stat-card"
                        style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; font-size: 2.5em; font-weight: bold;" id="reports-this-month">0
                        </h3>
                        <p style="margin: 0; font-size: 1.1em;">Reportes este Mes</p>
                    </div>

                    <div class="stat-card"
                        style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; font-size: 2.5em; font-weight: bold;" id="avg-priority">0</h3>
                        <p style="margin: 0; font-size: 1.1em;">Prioridad Promedio</p>
                    </div>

                    <div class="stat-card"
                        style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0; font-size: 2.5em; font-weight: bold;" id="completion-rate">0%
                        </h3>
                        <p style="margin: 0; font-size: 1.1em;">Tasa de Completitud</p>
                    </div>
                </div>

                <!-- Gr√°ficos y detalles -->
                <div style="margin-top: 30px;">
                    <h3>Distribuci√≥n por Tipo de Inspecci√≥n</h3>
                    <div id="inspection-types-chart"
                        style="height: 300px; background: #f9fafb; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin: 20px 0;">
                        <p style="color: #6b7280;">Cargando datos...</p>
                    </div>

                    <h3 style="margin-top: 30px;">Reportes por Mes</h3>
                    <div id="monthly-reports-chart"
                        style="height: 300px; background: #f9fafb; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin: 20px 0;">
                        <p style="color: #6b7280;">Cargando datos...</p>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button id="refresh-estadisticas-btn" class="btn btn-ghost" style="padding: 10px 20px;">üîÑ
                        Actualizar Estad√≠sticas</button>
                </div>
            </div>
        </div> <!-- End estadistica-section -->

    </div> <!-- End main-content -->

    <!-- Scripts: fecha/hora, bloqueo Cargo y comportamiento Turno -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            function pad(n) { return n.toString().padStart(2, '0'); }
            var d = new Date();
            var date = pad(d.getDate()) + '/' + pad(d.getMonth() + 1) + '/' + d.getFullYear();
            var time = pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
            // Mostrar fecha y hora local (sin zona entre par√©ntesis)
            var str = date + ' ' + time;
            var el = document.getElementById('report-date');
            if (el) el.textContent = str;
            var elHistorial = document.getElementById('report-date-historial');
            if (elHistorial) elHistorial.textContent = str;
            var elEstadistica = document.getElementById('report-date-estadistica');
            if (elEstadistica) elEstadistica.textContent = str;
            // Mostrar horario UTC: hora en la primera l√≠nea y fecha UTC en la segunda (sin leyenda previa)
            try {
                var utcHours = pad(d.getUTCHours());
                var utcMins = pad(d.getUTCMinutes());
                var utcSecs = pad(d.getUTCSeconds());
                var utcStr = utcHours + ':' + utcMins + ':' + utcSecs;
                var utcDateStr = pad(d.getUTCDate()) + '/' + pad(d.getUTCMonth() + 1) + '/' + d.getUTCFullYear();
                var utcEl = document.getElementById('report-utc');
                if (utcEl) utcEl.innerHTML = '<div><strong>' + utcStr + ' UTC</strong></div><div style="font-size:12px;color:#6b7280;margin-top:4px">' + utcDateStr + '</div>';
                var utcElHistorial = document.getElementById('report-utc-historial');
                if (utcElHistorial) utcElHistorial.innerHTML = '<div><strong>' + utcStr + ' UTC</strong></div><div style="font-size:12px;color:#6b7280;margin-top:4px">' + utcDateStr + '</div>';
                var utcElEstadistica = document.getElementById('report-utc-estadistica');
                if (utcElEstadistica) utcElEstadistica.innerHTML = '<div><strong>' + utcStr + ' UTC</strong></div><div style="font-size:12px;color:#6b7280;margin-top:4px">' + utcDateStr + '</div>';
            } catch (e) { }

            // Bloquear el campo Cargo al seleccionar una opci√≥n
            var cargoSelect = document.getElementById('report-role');
            var resetButton = document.getElementById('report-role-reset');
            if (cargoSelect && resetButton) {
                cargoSelect.addEventListener('change', function () {
                    cargoSelect.disabled = true;
                    resetButton.style.display = 'inline-block';
                });
                resetButton.addEventListener('click', function () {
                    cargoSelect.disabled = false;
                    resetButton.style.display = 'none';
                });
            }

            // Mostrar el selector Turno (Diurna/Nocturna) cuando se seleccione alg√∫n tipo de inspecci√≥n
            var tipoEls = document.getElementsByName('tipo_inspeccion');
            var turnoSection = document.getElementById('turno-section');
            if (tipoEls && turnoSection) {
                function updateTurno() {
                    var anyChecked = Array.prototype.slice.call(tipoEls).some(function (i) { return i.checked; });
                    turnoSection.style.display = anyChecked ? 'block' : 'none';
                    if (!anyChecked) {
                        var t = document.getElementsByName('turno');
                        Array.prototype.slice.call(t).forEach(function (r) { r.checked = false; });
                    }
                }
                Array.prototype.slice.call(tipoEls).forEach(function (el) { el.addEventListener('change', updateTurno); });
                updateTurno();
            }

            // Wiring para campos Lugar: agregar click para abrir mapa
            setTimeout(function () {
                try {
                    var lugarInputs = document.querySelectorAll('input[name*="lugar"]');
                    lugarInputs.forEach(function (input) {
                        input.addEventListener('click', function (e) {
                            e.preventDefault();
                            if (window.openMapPicker) window.openMapPicker(input);
                        });
                        input.style.cursor = 'pointer';
                        input.setAttribute('placeholder', 'Click para seleccionar en mapa');
                        input.style.pointerEvents = 'auto';
                    });
                } catch (e) { console.error('Error wiring map picker', e); }
            }, 500);
        });
    </script>

    <script>
        (function () {
            // Mostrar el selector Turno (Diurna/Nocturna) cuando se seleccione alg√∫n tipo de inspecci√≥n
            var tipoEls = document.getElementsByName('tipo_inspeccion');
            var turnoSection = document.getElementById('turno-section');
            if (!tipoEls || !turnoSection) return;
            function updateTurno() {
                var anyChecked = Array.prototype.slice.call(tipoEls).some(function (i) { return i.checked; });
                turnoSection.style.display = anyChecked ? 'block' : 'none';
                if (!anyChecked) {
                    // limpiar selecci√≥n de turno si se oculta
                    var t = document.getElementsByName('turno');
                    Array.prototype.slice.call(t).forEach(function (r) { r.checked = false; });
                }
            }
            Array.prototype.slice.call(tipoEls).forEach(function (el) { el.addEventListener('change', updateTurno); });
            // inicializar al cargar
            updateTurno();

            // --- comportamiento para Responsable: usar select similar a Cargo ---
            var authorSelect = document.getElementById('report-authors-select');
            var resetBtn = document.getElementById('report-authors-reset');
            if (authorSelect && resetBtn) {
                authorSelect.addEventListener('change', function () {
                    if (authorSelect.value) {
                        authorSelect.disabled = true;
                        resetBtn.style.display = 'inline-block';
                    }
                });
                resetBtn.addEventListener('click', function () {
                    authorSelect.disabled = false;
                    authorSelect.value = '';
                    resetBtn.style.display = 'none';
                });
            }
            // --- comportamiento para mostrar/ocultar los detalles por cada item ---
            var itemIds = [
                'tipo_area_movimiento', 'tipo_franjas', 'tipo_iluminacion', 'tipo_marcas', 'tipo_ayudas',
                'tipo_obstaculos', 'tipo_combustibles', 'tipo_construccion', 'tipo_ssei', 'tipo_vehiculos',
                'tipo_fauna', 'tipo_proteccion'
            ];
            itemIds.forEach(function (id) {
                var chk = document.getElementById(id);
                var det = document.getElementById('details_' + id);
                if (!chk || !det) return;
                chk.addEventListener('change', function () {
                    if (chk.checked) { det.style.display = 'block'; }
                    else {
                        det.style.display = 'none';
                        // limpiar campos dentro de det
                        Array.prototype.slice.call(det.querySelectorAll('input, textarea, select')).forEach(function (el) {
                            if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
                            else {
                                el.value = '';
                                // si es select de prioridad o condicion, quitar color de fondo
                                try {
                                    if (el.classList && el.classList.contains('priority-select')) el.style.backgroundColor = '';
                                    if (el.classList && el.classList.contains('condicion-select')) el.style.backgroundColor = '';
                                } catch (e) { }
                            }
                        });
                    }
                });
            });
        })();
    </script>

    <script>
        (function () {
            // A√±adir bot√≥n 'duplicar' (+) junto a cada item para crear instancias adicionales
            var counters = {};
            var baseItemIds = [
                'tipo_area_movimiento', 'tipo_franjas', 'tipo_iluminacion', 'tipo_marcas', 'tipo_ayudas',
                'tipo_obstaculos', 'tipo_combustibles', 'tipo_construccion', 'tipo_ssei', 'tipo_vehiculos',
                'tipo_fauna', 'tipo_proteccion'
            ];

            function setupItemControlsFor(id) {
                var chk = document.getElementById(id);
                var det = document.getElementById('details_' + id);
                var doneBtn = document.getElementById('done_' + id);
                var updateBtn = document.getElementById('update_' + id);
                var dupBtn = document.getElementById('dup_' + id);
                var clearBtn = document.getElementById('clear_' + id);
                if (!chk) return;

                // Helper: detecta si el item tiene datos (campos con valor o selecciones)
                function hasItemData() {
                    try {
                        // if checkbox itself is checked, consider it as data
                        if (chk && chk.checked) return true;
                        if (!det) return false;
                        var els = Array.prototype.slice.call(det.querySelectorAll('input,textarea,select'));
                        for (var i = 0; i < els.length; i++) {
                            var el = els[i];
                            if (!el) continue;
                            if (el.type === 'checkbox' || el.type === 'radio') { if (el.checked) return true; }
                            else if ((el.value || '').toString().trim() !== '') return true;
                        }
                    } catch (e) { }
                    return false;
                }

                function updateClearVisibility() {
                    try {
                        if (!clearBtn) return;
                        var has = hasItemData();
                        clearBtn.style.display = has ? 'inline-block' : 'none';
                    } catch (e) { }
                }

                function refresh() {
                    if (chk.disabled) {
                        if (doneBtn) doneBtn.style.display = 'none';
                        if (updateBtn) updateBtn.style.display = 'inline-block';
                    } else {
                        if (chk.checked) { if (doneBtn) doneBtn.style.display = 'inline-block'; } else { if (doneBtn) doneBtn.style.display = 'none'; }
                        if (updateBtn) updateBtn.style.display = 'none';
                    }
                    // mostrar/ocultar botones + y Clear seg√∫n si el checkbox est√° seleccionado
                    if (dupBtn) dupBtn.style.display = chk.checked ? 'inline-block' : 'none';
                    updateClearVisibility();
                }

                chk.addEventListener('change', function () {
                    if (det) { det.style.display = chk.checked ? 'block' : 'none'; }
                    refresh();
                });

                if (doneBtn) {
                    doneBtn.addEventListener('click', function () {
                        if (chk.checked) {
                            chk.disabled = true;
                            if (det) {
                                Array.prototype.slice.call(det.querySelectorAll('input, textarea, select')).forEach(function (el) { try { el.disabled = true; } catch (e) { } });
                            }
                        }
                        refresh();
                    });
                }
                if (updateBtn) {
                    updateBtn.addEventListener('click', function () {
                        chk.disabled = false;
                        if (det) {
                            Array.prototype.slice.call(det.querySelectorAll('input, textarea, select')).forEach(function (el) { try { el.disabled = false; } catch (e) { } });
                        }
                        refresh();
                    });
                }

                if (dupBtn) {
                    dupBtn.addEventListener('click', function () { duplicateItem(id); });
                }
                if (clearBtn) {
                    clearBtn.addEventListener('click', function () {
                        try {
                            // uncheck the checkbox, hide details and clear values
                            if (chk) { chk.checked = false; chk.disabled = false; }
                            if (det) {
                                det.style.display = 'none';
                                Array.prototype.slice.call(det.querySelectorAll('input, textarea, select')).forEach(function (el) {
                                    try {
                                        if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
                                        else el.value = '';
                                        el.disabled = false;
                                        if (el.classList && el.classList.contains('priority-select')) el.style.backgroundColor = '';
                                        if (el.classList && el.classList.contains('condicion-select')) el.style.backgroundColor = '';
                                    } catch (e) { }
                                });
                            }
                            // update visuals
                            if (doneBtn) doneBtn.style.display = 'none';
                            if (updateBtn) updateBtn.style.display = 'none';
                            if (clearBtn) clearBtn.style.display = 'none';
                            // persist state
                            try { if (window.saveFormState) window.saveFormState(); } catch (e) { }
                        } catch (e) { console.error('Error clearing item', id, e); }
                    });
                }

                // si hay panel de detalles, escuchar cambios para mostrar/ocultar Clear
                if (det) {
                    try {
                        Array.prototype.slice.call(det.querySelectorAll('input,textarea,select')).forEach(function (el) {
                            el.addEventListener('input', updateClearVisibility);
                            el.addEventListener('change', updateClearVisibility);
                        });
                    } catch (e) { }
                }

                // inicializar estado visual
                refresh();
            }

            function duplicateItem(origId) {
                var origChk = document.getElementById(origId);
                var origDet = document.getElementById('details_' + origId);
                if (!origChk) return;
                counters[origId] = (counters[origId] || 0) + 1;
                var suffix = '_dup' + counters[origId];
                var newId = origId + suffix;

                // clone checkbox
                var newChk = origChk.cloneNode(false);
                newChk.id = newId;
                newChk.checked = false;
                newChk.disabled = false;

                // clone label
                var origLabel = document.querySelector('label[for="' + origId + '"]');
                var newLabel = origLabel ? origLabel.cloneNode(true) : null;
                if (newLabel) newLabel.setAttribute('for', newId);

                // create done/update buttons for the clone
                var newDone = document.createElement('button'); newDone.type = 'button'; newDone.id = 'done_' + newId; newDone.className = 'item-done'; newDone.style.display = 'none'; newDone.style.marginLeft = '6px'; newDone.textContent = 'Done';
                var newUpdate = document.createElement('button'); newUpdate.type = 'button'; newUpdate.id = 'update_' + newId; newUpdate.className = 'item-update'; newUpdate.style.display = 'none'; newUpdate.style.marginLeft = '6px'; newUpdate.textContent = 'Update';
                var newDup = document.createElement('button'); newDup.type = 'button'; newDup.id = 'dup_' + newId; newDup.className = 'item-duplicate'; newDup.style.display = 'none'; newDup.style.marginLeft = '6px'; newDup.textContent = '+';
                var newClear = document.createElement('button'); newClear.type = 'button'; newClear.id = 'clear_' + newId; newClear.className = 'item-done item-clear'; newClear.style.display = 'none'; newClear.style.marginLeft = '6px'; newClear.style.cssFloat = 'right'; newClear.textContent = 'Clear';
                var br = document.createElement('br');

                // clone details panel and adjust ids/names
                var newDet = origDet ? origDet.cloneNode(true) : null;
                if (newDet) {
                    newDet.id = 'details_' + newId;
                    // update any element ids inside
                    Array.prototype.slice.call(newDet.querySelectorAll('[id]')).forEach(function (el) { if (el.id) el.id = el.id.replace(origId, newId); });
                    // update name attributes and clear values
                    Array.prototype.slice.call(newDet.querySelectorAll('[name]')).forEach(function (el) {
                        if (el.name) el.name = el.name.replace(origId, newId);
                        try {
                            if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
                            else el.value = '';
                            el.disabled = false;
                            if (el.classList && el.classList.contains('priority-select')) el.style.backgroundColor = '';
                            if (el.classList && el.classList.contains('condicion-select')) el.style.backgroundColor = '';
                        } catch (e) { }
                    });
                }

                // insert cloned nodes after the original details block (or after the original checkbox if no details)
                var insertAfter = origDet ? origDet : origChk;
                var parent = insertAfter.parentNode;
                var ref = insertAfter.nextSibling;
                var frag = document.createDocumentFragment();
                frag.appendChild(newChk);
                if (newLabel) frag.appendChild(newLabel);
                frag.appendChild(newDone);
                frag.appendChild(newUpdate);
                frag.appendChild(newDup);
                frag.appendChild(newClear);
                frag.appendChild(br);
                if (newDet) frag.appendChild(newDet);
                if (ref) parent.insertBefore(frag, ref);
                else parent.appendChild(frag);

                // attach controls to the clone
                setupItemControlsFor(newId);

                // attach map picker to the new Lugar input
                try {
                    if (newDet) {
                        var lugarInput = newDet.querySelector('input[name*="lugar"]');
                        if (lugarInput) {
                            lugarInput.addEventListener('click', function (e) {
                                e.preventDefault();
                                if (window.openMapPicker) window.openMapPicker(lugarInput);
                            });
                            lugarInput.style.cursor = 'pointer';
                            lugarInput.setAttribute('placeholder', 'Click para seleccionar en mapa');
                            lugarInput.style.pointerEvents = 'auto';
                        }
                    }
                } catch (e) { }

                // also attach hallazgo 'Otro' handler if present
                try {
                    var hallSelect = document.getElementById('hallazgo_' + newId);
                    var hallOther = document.getElementById('hallazgo_other_' + newId);
                    if (hallSelect && hallOther) {
                        hallSelect.addEventListener('change', function () { if (hallSelect.value === 'Otro') hallOther.style.display = 'block'; else { hallOther.style.display = 'none'; hallOther.value = ''; } });
                        hallSelect.dispatchEvent(new Event('change'));
                    }
                } catch (e) { }

                // attach priority/condition color handlers for the clone
                try {
                    var prio = newDet ? newDet.querySelector('select.priority-select') : null;
                    if (prio) { prio.addEventListener('change', function () { var v = prio.value; var colorMap = { '1': '#28a745', '2': '#ffc107', '3': '#ff8c00' }; prio.style.backgroundColor = colorMap[v] || ''; }); }
                    var cond = newDet ? newDet.querySelector('select.condicion-select') : null;
                    if (cond) { cond.addEventListener('change', function () { var v = cond.value; var condMap = { 'Satisfactorio': '#28a745', 'No Satisfactorio': '#dc3545', 'N/A': '#6c757d' }; cond.style.backgroundColor = condMap[v] || ''; }); }
                } catch (e) { }
            }

            // Crear y conectar botones + para los items existentes
            baseItemIds.forEach(function (id) {
                var doneBtn = document.getElementById('done_' + id);
                // crear bot√≥n duplicar si no existe
                if (!document.getElementById('dup_' + id)) {
                    var dup = document.createElement('button'); dup.type = 'button'; dup.id = 'dup_' + id; dup.className = 'item-duplicate'; dup.style.marginLeft = '6px'; dup.style.display = 'none'; dup.textContent = '+';
                    if (doneBtn && doneBtn.parentNode) doneBtn.parentNode.insertBefore(dup, doneBtn.nextSibling);
                    else {
                        var chk = document.getElementById(id);
                        if (chk && chk.parentNode) chk.parentNode.insertBefore(dup, chk.nextSibling);
                    }
                }
                if (!document.getElementById('clear_' + id)) {
                    var clearBtn = document.createElement('button'); clearBtn.type = 'button'; clearBtn.id = 'clear_' + id; clearBtn.className = 'item-done item-clear'; clearBtn.style.marginLeft = '6px'; clearBtn.style.cssFloat = 'right'; clearBtn.style.display = 'none'; clearBtn.textContent = 'Clear';
                    var doneBtnLocal = document.getElementById('done_' + id);
                    if (doneBtnLocal && doneBtnLocal.parentNode) doneBtnLocal.parentNode.insertBefore(clearBtn, doneBtnLocal.nextSibling);
                    else {
                        var chk2 = document.getElementById(id);
                        if (chk2 && chk2.parentNode) chk2.parentNode.insertBefore(clearBtn, chk2.nextSibling);
                    }
                }
                // setup controls for existing and future clones
                setupItemControlsFor(id);
            });
            // Exponer API m√≠nima para duplicar desde fuera (necesario para restauraci√≥n)
            try { window.mhr = window.mhr || {}; window.mhr.duplicateItem = duplicateItem; window.mhr.counters = counters; window.mhr.setupItemControlsFor = setupItemControlsFor; } catch (e) { }
        })();
    </script>

    <!-- ‚îÄ‚îÄ‚îÄ Script: Evidencias Fotogr√°ficas por Item ‚îÄ‚îÄ‚îÄ -->
    <script>
    (function () {
        // Almac√©n global: { [itemId]: [{dataURL, name}, ...] }
        window.itemPhotos = window.itemPhotos || {};

        /**
         * Inyecta el campo de fotos en el panel de detalles de un item.
         * Se inserta despu√©s del <br> que sigue al label de Condici√≥n.
         */
        function injectPhotoField(det) {
            if (!det || det.querySelector('.photo-upload-area')) return; // ya existe
            var condSelect = det.querySelector('.condicion-select');
            if (!condSelect) return;

            // Buscar el <br> inmediato despu√©s del label/select de condici√≥n
            var condLabel = condSelect.closest ? condSelect.closest('label') : condSelect.parentElement;
            var refNode = null;
            // Recorrer desde condLabel buscando un <br> hermano siguiente
            var sibling = (condLabel || condSelect).nextSibling;
            while (sibling) {
                if (sibling.nodeName === 'BR') { refNode = sibling.nextSibling; break; }
                sibling = sibling.nextSibling;
            }

            // Crear el campo de foto
            var wrapper = document.createElement('div');
            wrapper.className = 'photo-upload-area';
            wrapper.innerHTML =
                '<div style="font-size:13px;color:#374151;margin-bottom:4px;">üì∑ Evidencias fotogr√°ficas (opcional)</div>' +
                '<div class="photo-upload-btns">' +
                '<label class="photo-upload-label">üìÅ Adjuntar archivo<input type="file" class="photo-upload-input" accept="image/*" multiple></label>' +
                '<label class="photo-upload-label photo-camera-label">üì∏ Tomar foto<input type="file" class="photo-upload-input" accept="image/*" capture="environment"></label>' +
                '</div>' +
                '<div class="photo-previews"></div>';
            var br = document.createElement('br');

            if (refNode) {
                det.insertBefore(wrapper, refNode);
                det.insertBefore(br, refNode);
            } else {
                // Insertar antes de Observaciones si no hay referencia
                var obsLabel = null;
                var children = det.childNodes;
                for (var i = 0; i < children.length; i++) {
                    var n = children[i];
                    if (n.nodeName === 'LABEL' && n.textContent && /observac/i.test(n.textContent)) {
                        obsLabel = n; break;
                    }
                }
                if (obsLabel) {
                    det.insertBefore(br, obsLabel);
                    det.insertBefore(wrapper, br);
                } else {
                    det.appendChild(wrapper);
                }
            }
        }

        /** Obtiene el itemId a partir del panel de detalles */
        function getItemId(det) {
            if (!det || !det.id) return null;
            return det.id.replace(/^details_/, '');
        }

        /** Renderiza las miniaturas en el container de previews */
        function renderPreviews(det) {
            var itemId = getItemId(det);
            if (!itemId) return;
            var previewsDiv = det.querySelector('.photo-previews');
            if (!previewsDiv) return;
            previewsDiv.innerHTML = '';
            var photos = window.itemPhotos[itemId] || [];
            photos.forEach(function (photo, idx) {
                var wrapper = document.createElement('div');
                wrapper.className = 'photo-thumb-wrapper';
                var img = document.createElement('img');
                img.src = photo.dataURL;
                img.className = 'photo-thumb';
                img.alt = photo.name || ('Foto ' + (idx + 1));
                var removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'photo-thumb-remove';
                removeBtn.title = 'Eliminar foto';
                removeBtn.textContent = '√ó';
                removeBtn.setAttribute('data-item-id', itemId);
                removeBtn.setAttribute('data-photo-idx', idx);
                wrapper.appendChild(img);
                wrapper.appendChild(removeBtn);
                previewsDiv.appendChild(wrapper);
            });
        }

        /** Maneja el cambio en un input de archivo */
        function handleFileChange(input) {
            var det = input.closest ? input.closest('.item-details') : null;
            if (!det) { var p = input.parentElement; while (p && !p.classList.contains('item-details')) p = p.parentElement; det = p; }
            if (!det) return;
            var itemId = getItemId(det);
            if (!itemId) return;
            window.itemPhotos[itemId] = window.itemPhotos[itemId] || [];
            var files = Array.prototype.slice.call(input.files || []);
            var pending = files.length;
            if (!pending) return;
            files.forEach(function (file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    window.itemPhotos[itemId].push({ dataURL: e.target.result, name: file.name });
                    pending--;
                    if (pending === 0) {
                        renderPreviews(det);
                        input.value = ''; // reset para permitir re-seleccionar misma imagen
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // Delegaci√≥n de eventos: cambio en file input de fotos
        document.addEventListener('change', function (e) {
            if (e.target && e.target.classList && e.target.classList.contains('photo-upload-input')) {
                handleFileChange(e.target);
            }
        });

        // Delegaci√≥n de eventos: eliminar foto
        document.addEventListener('click', function (e) {
            if (e.target && e.target.classList && e.target.classList.contains('photo-thumb-remove')) {
                var itemId = e.target.getAttribute('data-item-id');
                var idx = parseInt(e.target.getAttribute('data-photo-idx'), 10);
                if (itemId && !isNaN(idx) && window.itemPhotos[itemId]) {
                    window.itemPhotos[itemId].splice(idx, 1);
                    // re-render previews
                    var det = document.getElementById('details_' + itemId);
                    if (det) renderPreviews(det);
                }
            }
        });

        // Inyectar campo de fotos en todos los item-details al cargar
        document.addEventListener('DOMContentLoaded', function () {
            var dets = document.querySelectorAll('.item-details');
            Array.prototype.forEach.call(dets, function (det) { injectPhotoField(det); });
        });

        // Parchear duplicateItem para inyectar fotos en el clon
        var originalSetup = null;
        var checkPatch = setInterval(function () {
            if (window.mhr && window.mhr.duplicateItem) {
                clearInterval(checkPatch);
                var origDup = window.mhr.duplicateItem;
                window.mhr.duplicateItem = function (origId) {
                    origDup(origId);
                    // El clon se inserta en el DOM; encontrarlo y agregarle fotos
                    setTimeout(function () {
                        var counters = window.mhr.counters || {};
                        var suffix = '_dup' + (counters[origId] || 1);
                        var newDetId = 'details_' + origId + suffix;
                        var newDet = document.getElementById(newDetId);
                        if (newDet) {
                            // Eliminar campo de fotos clonado (vendr√° con valores del clon) y reinsertar limpio
                            var existingArea = newDet.querySelector('.photo-upload-area');
                            if (existingArea) existingArea.parentNode && existingArea.parentNode.removeChild(existingArea);
                            injectPhotoField(newDet);
                        }
                    }, 50);
                };
            }
        }, 200);

        // Exponer helper para el PDF
        window.mhr = window.mhr || {};
        window.mhr.getItemPhotos = function (itemId) { return window.itemPhotos[itemId] || []; };
    })();
    </script>

    <!-- contenedor oculto para generar el PDF -->
    <div id="report-summary"
        style="display:none; padding:18px; background:#fff; max-width:900px; margin:0 auto; border-radius:6px;"></div>

    <!-- Panel de vista previa del PDF (derecha) -->
    <div id="pdf-preview-container" aria-hidden="true">
        <div id="pdf-spinner">
            <div class="spinner" aria-hidden="true"></div>
        </div>
        <div id="pdf-preview-actions">
            <button id="pdf-download-btn" title="Descargar PDF">Descargar</button>
            <button id="pdf-preview-close" title="Cerrar vista">Cerrar</button>
        </div>
        <iframe id="pdf-preview-frame" title="Vista previa del PDF"></iframe>
    </div>

    <!-- Bot√≥n fijo: Limpiar todo (limpia todos los items seleccionados) -->
    <button id="clear-all-btn" class="clear-all-btn" title="Limpiar todo" aria-label="Limpiar todo">Limpiar
        todo</button>

    <!-- Script: bot√≥n 'Limpiar todo' - confirma y limpia todos los √≠tems seleccionados -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var btn = document.getElementById('clear-all-btn');
            if (!btn) return;
            btn.addEventListener('click', function (e) {
                try { e.preventDefault(); e.stopPropagation(); } catch (err) { }
                console.log('Clear all clicked');
                var ok = window.confirm('¬øEst√°s seguro que deseas limpiar TODOS los √≠tems seleccionados y otros campos del formulario? Esta acci√≥n quitar√° los √≠tems del reporte.');
                if (!ok) { console.log('Clear all canceled'); return; }

                // 1) Limpiar todos los items tipo_* (checkboxes y sus paneles)
                var itemCheckboxes = Array.prototype.slice.call(document.querySelectorAll('input[type="checkbox"][id^="tipo_"]'));
                itemCheckboxes.forEach(function (chk) {
                    try {
                        var id = chk.id;
                        chk.checked = false;
                        chk.disabled = false;
                        var det = document.getElementById('details_' + id);
                        if (det) {
                            det.style.display = 'none';
                            Array.prototype.slice.call(det.querySelectorAll('input, textarea, select')).forEach(function (el) {
                                try {
                                    if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
                                    else el.value = '';
                                    el.disabled = false;
                                    if (el.classList && el.classList.contains('priority-select')) el.style.backgroundColor = '';
                                    if (el.classList && el.classList.contains('condicion-select')) el.style.backgroundColor = '';
                                } catch (e) { }
                            });
                        }
                        var doneBtn = document.getElementById('done_' + id);
                        var updateBtn = document.getElementById('update_' + id);
                        if (doneBtn) doneBtn.style.display = 'none';
                        if (updateBtn) updateBtn.style.display = 'none';
                    } catch (e) { console.error('Error clearing item', chk && chk.id, e); }
                });

                // 2) Limpiar el resto de campos dentro del formulario principal
                try {
                    var form = document.getElementById('report-form');
                    if (form) {
                        Array.prototype.slice.call(form.querySelectorAll('input, textarea, select')).forEach(function (el) {
                            try {
                                // evitar tocar botones y submit
                                if (el.tagName === 'BUTTON' || (el.type && (el.type === 'submit' || el.type === 'button'))) return;
                                if (el.type === 'checkbox' || el.type === 'radio') {
                                    el.checked = false;
                                    el.disabled = false;
                                } else {
                                    el.value = '';
                                    el.disabled = false;
                                }
                                if (el.classList && el.classList.contains('priority-select')) el.style.backgroundColor = '';
                                if (el.classList && el.classList.contains('condicion-select')) el.style.backgroundColor = '';
                            } catch (e) { }
                        });
                    }
                } catch (e) { console.error('Error clearing form fields', e); }

                // 3) Restablecer controles especiales y botones de reset visibles
                try {
                    var authorSel = document.getElementById('report-authors-select');
                    var authorReset = document.getElementById('report-authors-reset');
                    if (authorSel) { authorSel.value = ''; authorSel.disabled = false; }
                    if (authorReset) authorReset.style.display = 'none';

                    var roleSel = document.getElementById('report-role');
                    var roleReset = document.getElementById('report-role-reset');
                    var roleOther = document.getElementById('report-role-other');
                    if (roleSel) { roleSel.selectedIndex = 0; roleSel.disabled = false; }
                    if (roleReset) roleReset.style.display = 'none';
                    if (roleOther) { roleOther.value = ''; roleOther.style.display = 'none'; }
                } catch (e) { }

                // 4) Limpieza visual adicional: ocultar detalles que puedan no haberse limpiado
                try {
                    Array.prototype.slice.call(document.querySelectorAll('[id^="details_"]')).forEach(function (d) { try { d.style.display = 'none'; } catch (e) { } });
                } catch (e) { }

                // 5) Persistir estado (guardar formulario limpio)
                try { if (window.saveFormState) window.saveFormState(); else console.log('saveFormState not available'); } catch (e) { console.error('Error saving state', e); }

                // feedback breve
                var original = btn.textContent;
                btn.textContent = 'Limpiado';
                setTimeout(function () { btn.textContent = original; }, 1800);
            });
        });
    </script>

    <!-- html2pdf CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

    <script>
        // Manejar env√≠o del formulario: compilar datos y generar PDF
        document.addEventListener('DOMContentLoaded', function () {
            var form = document.getElementById('report-form');
            if (!form) return;
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                // ‚îÄ‚îÄ‚îÄ SOPORTE OFFLINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                if (!navigator.onLine) {
                    if (typeof window.saveFormOffline === 'function') {
                        window.saveFormOffline();
                    } else {
                        alert('Sin conexi√≥n a Internet. No se pudo guardar el reporte.');
                    }
                    return;
                }
                // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

                // Feedback visual inmediato
                var submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('input[type="submit"]');
                var originalBtnText = '';
                if (submitBtn) {
                    originalBtnText = submitBtn.textContent || submitBtn.value;
                    submitBtn.disabled = true;
                    if (submitBtn.tagName === 'BUTTON') submitBtn.textContent = 'Guardando en base de datos...';
                    else submitBtn.value = 'Guardando en base de datos...';
                }

                // recolectar metadatos
                var fecha = document.getElementById('report-date') ? document.getElementById('report-date').textContent : '';
                // Quitar zona horaria si existe en el texto (ej. "dd/mm/yyyy hh:mm:ss (Zona)")
                fecha = fecha.replace(/\s*\(.*\)\s*$/, '').trim();
                // Leer responsable desde el select (usar el texto visible)
                var autor = '';
                var authorSel = document.getElementById('report-authors-select');
                if (authorSel) { var opt = authorSel.options[authorSel.selectedIndex]; autor = opt ? (opt.text || opt.label || opt.value) : (authorSel.value || ''); }
                // Obtener el texto visible de la opci√≥n seleccionada en 'Cargo'. Si es 'Otro', usar el campo especificado.
                var cargo = '';
                var roleEl = document.getElementById('report-role');
                if (roleEl) {
                    var selOpt = roleEl.options[roleEl.selectedIndex];
                    cargo = selOpt ? (selOpt.text || selOpt.label || selOpt.value) : roleEl.value;
                    if (selOpt && (selOpt.value === 'Otro' || (selOpt.text || '').toLowerCase().indexOf('otro') !== -1)) {
                        var other = document.getElementById('report-role-other');
                        if (other && other.value.trim()) cargo = other.value.trim();
                    }
                }
                // Obtener Tipo(s) de Inspecci√≥n seleccionadas
                var tipos = Array.prototype.slice.call(document.querySelectorAll('input[name="tipo_inspeccion"]'))
                    .filter(function (i) { return i.checked; })
                    .map(function (i) {
                        var lbl = document.querySelector('label[for="' + i.id + '"]');
                        return (lbl ? lbl.textContent.trim() : (i.value || '')).trim();
                    }).filter(Boolean);
                var tiposText = tipos.length ? tipos.join(', ') : '-';
                // Obtener Turno seleccionado (si aplica)
                var turnoEl = document.querySelector('input[name="turno"]:checked');
                var turnoText = turnoEl ? (document.querySelector('label[for="' + turnoEl.id + '"]') ? document.querySelector('label[for="' + turnoEl.id + '"]').textContent.trim() : (turnoEl.value || '')) : '-';
                // calcular horario UTC (hora) y fecha UTC para mostrar en el PDF
                function pad(n) { return n.toString().padStart(2, '0'); }
                var now = new Date();
                var utcTimeStr = pad(now.getUTCHours()) + ':' + pad(now.getUTCMinutes()) + ':' + pad(now.getUTCSeconds()) + ' UTC';
                var utcDateStr = pad(now.getUTCDate()) + '/' + pad(now.getUTCMonth() + 1) + '/' + now.getUTCFullYear();
                // Generar folio basado en fecha/hora UTC: e.g. 20251120-142305
                var folio = now.getUTCFullYear().toString() + pad(now.getUTCMonth() + 1) + pad(now.getUTCDate()) + '-' + pad(now.getUTCHours()) + pad(now.getUTCMinutes()) + pad(now.getUTCSeconds());

                // obtener items seleccionados
                var items = Array.prototype.slice.call(document.querySelectorAll('input[type="checkbox"][id^="tipo_"]'));
                var filled = [];
                items.forEach(function (chk) {
                    if (!chk.checked) return;
                    var id = chk.id;
                    var lbl = document.querySelector('label[for="' + id + '"]');
                    var name = lbl ? lbl.textContent.trim() : id;
                    var det = document.getElementById('details_' + id);
                    var fields = [];
                    if (det) {
                        Array.prototype.slice.call(det.querySelectorAll('input, textarea, select')).forEach(function (el) {
                            if (!el) return;
                            var val = '';
                            if (el.type === 'checkbox' || el.type === 'radio') { if (!el.checked) return; val = el.value || 'Seleccionado'; }
                            else val = (el.value || '').toString().trim();
                            if (val === '') return;
                            // intentar obtener label
                            var parentLabel = el.closest('label');
                            var key = '';
                            if (parentLabel) { key = parentLabel.childNodes[0] ? parentLabel.childNodes[0].textContent.trim() : (el.name || el.id); }
                            if (!key) key = el.name || el.id;
                            // Eliminar dos puntos finales duplicados en las claves (ej. "Lugar:")
                            try { key = key.replace(/[:Ôºö]\s*$/, '').trim(); } catch (e) { }
                            fields.push({ key: key, value: val });
                        });
                    }
                    filled.push({ id: id, name: name, fields: fields });
                });

                if (filled.length === 0) {
                    alert('No hay items seleccionados para generar el reporte.');
                    return;
                }

                // Guardar en Supabase
                var saveToSupabase = async function (pdfUrl) {
                    console.log('Iniciando guardado en Supabase...');
                    try {
                        if (!window.supabaseClient) {
                            console.error('Cliente Supabase no inicializado (window.supabaseClient is missing)');
                            alert('Error: No hay conexi√≥n con la base de datos.');
                            return null;
                        }

                        var { data: { session } } = await window.supabaseClient.auth.getSession();
                        if (!session) {
                            console.warn('No hay sesi√≥n activa, no se guardar√° en base de datos.');
                            alert('Atenci√≥n: No has iniciado sesi√≥n. El reporte se generar√° en PDF pero NO se guardar√° en la base de datos.');
                            return null;
                        }

                        console.log('Sesi√≥n activa:', session.user.email);

                        // 1. Insertar reporte principal
                        var reportPayload = {
                            folio: folio,
                            fecha_local: fecha,
                            fecha_utc: utcDateStr + ' ' + utcTimeStr,
                            tipo_inspeccion: tiposText,
                            turno: turnoText,
                            responsable: autor,
                            cargo: cargo,
                            pdf_url: pdfUrl || null
                        };
                        console.log('Insertando reporte:', reportPayload);

                        var { data: reportData, error: reportError } = await window.supabaseClient
                            .from('reports')
                            .insert([reportPayload])
                            .select();

                        if (reportError) {
                            console.error('Error guardando reporte:', reportError);
                            alert('Error guardando en base de datos: ' + reportError.message);
                            return null;
                        }

                        var reportId = reportData[0].id;
                        console.log('Reporte guardado con ID:', reportId);

                        // 2. Preparar items para insertar
                        var itemsToInsert = [];
                        filled.forEach(function (f) {
                            var lugarVal = '';
                            var hallazgoVal = '';
                            var condicionVal = '';
                            var observacionesVal = '';
                            var prioridadVal = '';
                            var codigoVal = '';

                            f.fields.forEach(function (ff) {
                                var k = ff.key.toLowerCase();
                                var v = ff.value;
                                if (k.includes('lugar')) lugarVal = v;
                                else if (k.includes('hallazgo')) hallazgoVal = v;
                                else if (k.includes('condici')) condicionVal = v;
                                else if (k.includes('observac')) observacionesVal = v;
                                else if (k.includes('prioridad')) prioridadVal = v;
                                else if (k.includes('codigo') || k.includes('seguimiento')) codigoVal = v;
                            });

                            itemsToInsert.push({
                                report_id: reportId,
                                categoria: f.name,
                                lugar: lugarVal,
                                hallazgo: hallazgoVal,
                                condicion: condicionVal,
                                observaciones: observacionesVal,
                                prioridad: prioridadVal,
                                codigo_seguimiento: codigoVal
                            });
                        });

                        console.log('Insertando items:', itemsToInsert);

                        // 3. Insertar items
                        var { error: itemsError } = await window.supabaseClient
                            .from('report_items')
                            .insert(itemsToInsert);

                        if (itemsError) {
                            console.error('Error guardando items:', itemsError);
                            alert('Reporte guardado, pero hubo error al guardar los detalles: ' + itemsError.message);
                        } else {
                            console.log('Items guardados exitosamente.');
                        }

                        // 4. Subir evidencias fotogr√°ficas a Storage e insertar en item_photos
                        try {
                            var photosToInsert = [];
                            for (var fi = 0; fi < filled.length; fi++) {
                                var f = filled[fi];
                                var photos = (window.mhr && window.mhr.getItemPhotos) ? window.mhr.getItemPhotos(f.id) : [];
                                if (!photos || photos.length === 0) continue;
                                for (var pi = 0; pi < photos.length; pi++) {
                                    var photo = photos[pi];
                                    try {
                                        // Convertir dataURL a Blob
                                        var arr = photo.dataURL.split(',');
                                        var mime = (arr[0].match(/:(.*?);/) || [])[1] || 'image/jpeg';
                                        var bstr = atob(arr[1]);
                                        var n = bstr.length;
                                        var u8arr = new Uint8Array(n);
                                        while (n--) u8arr[n] = bstr.charCodeAt(n);
                                        var photoBlob = new Blob([u8arr], { type: mime });

                                        // Nombre de archivo √∫nico
                                        var ext = mime.split('/')[1] || 'jpg';
                                        var photoFilename = 'photos/' + folio + '_item' + (fi + 1) + '_' + pi + '_' + Date.now() + '.' + ext;

                                        // Subir al bucket 'photos'
                                        var { data: photoData, error: photoUploadErr } = await window.supabaseClient
                                            .storage.from('photos')
                                            .upload(photoFilename, photoBlob, { cacheControl: '3600', upsert: false });

                                        if (photoUploadErr) {
                                            console.warn('Error subiendo foto:', photoUploadErr);
                                        } else {
                                            photosToInsert.push({
                                                report_id: reportId,
                                                item_id: f.id,
                                                item_categoria: f.name,
                                                item_numero: fi + 1,
                                                photo_url: photoFilename,
                                                photo_name: photo.name || (photoFilename)
                                            });
                                        }
                                    } catch (photoErr) {
                                        console.warn('Error procesando foto ' + pi + ' del item ' + f.id + ':', photoErr);
                                    }
                                }
                            }

                            if (photosToInsert.length > 0) {
                                var { error: photosDbErr } = await window.supabaseClient
                                    .from('item_photos')
                                    .insert(photosToInsert);
                                if (photosDbErr) {
                                    console.warn('Error guardando referencias de fotos en DB:', photosDbErr);
                                } else {
                                    console.log('Evidencias fotogr√°ficas guardadas:', photosToInsert.length, 'foto(s).');
                                }
                            }
                        } catch (allPhotosErr) {
                            console.warn('Error general en subida de evidencias:', allPhotosErr);
                        }

                        return reportId;

                    } catch (e) {
                        console.error('Excepci√≥n guardando en Supabase:', e);
                        alert('Error inesperado al guardar en base de datos: ' + e.message);
                        return null;
                    }
                };

                // Funci√≥n para subir PDF
                var uploadPdfToSupabase = async function (blob, folio) {
                    try {
                        if (!window.supabaseClient) return null;
                        var { data: { session } } = await window.supabaseClient.auth.getSession();
                        if (!session) return null;

                        var filename = 'report_' + folio + '_' + new Date().getTime() + '.pdf';
                        var { data, error } = await window.supabaseClient
                            .storage
                            .from('reports')
                            .upload(filename, blob, {
                                cacheControl: '3600',
                                upsert: false
                            });

                        if (error) {
                            console.error('Error subiendo PDF:', error);
                            // Manejo espec√≠fico si el bucket no existe
                            var msg = (error && (error.message || error.error_description || JSON.stringify(error))) || 'Error desconocido';
                            if (msg.toString().toLowerCase().indexOf('bucket not found') !== -1 || (error && error.status === 404)) {
                                var guidance = 'El bucket de almacenamiento "reports" no existe en tu proyecto de Supabase.\n\nPasos sugeridos:\n1) Entra al Dashboard de Supabase -> Storage -> Create new bucket.\n2) Crea un bucket llamado "reports" (temporalmente puedes marcarlo Public para pruebas).\n3) Actualiza las pol√≠ticas si quieres controlar acceso (ver README).\n\nSi quieres, puedo agregar instrucciones autom√°ticas o intentar usar createSignedUrl si el bucket debe permanecer privado.';
                                alert('No se pudo subir el PDF: Bucket not found.\n\n' + guidance);
                            } else {
                                alert('No se pudo subir el PDF: ' + msg);
                            }
                            return null;
                        }

                        // Guardar el path del archivo (no la URL p√∫blica, para buckets privados)
                        return filename;
                    } catch (e) {
                        console.error('Excepci√≥n subiendo PDF:', e);
                        alert('Excepci√≥n subiendo PDF: ' + (e && e.message ? e.message : JSON.stringify(e)));
                        return null;
                    }
                };

                // Modificamos el flujo: Primero generamos PDF (blob), luego subimos, luego guardamos data
                // Pero html2pdf es complejo de separar. 
                // Estrategia: Usar html2pdf para obtener el blob, luego subir, luego guardar data, luego descargar.

                // Construir HTML de resumen
                var container = document.getElementById('report-summary');
                var html = '<div style="font-family:Arial,Helvetica,sans-serif;color:#0f1724;">';
                // peque√±o helper para escapar texto antes de insertarlo en el HTML del PDF
                function escapeHtml(str) {
                    try { return str.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }
                    catch (e) { return '' + str; }
                }
                // Genera el HTML de la celda Lugar: imagen satelital + coordenadas + enlace Google Maps
                function buildLugarHtml(f, lugarVal) {
                    if (!lugarVal) return '<span style="color:#9ca3af">-</span>';
                    var h = '<div style="font-size:11px;font-weight:600;margin-bottom:4px;">' + escapeHtml(lugarVal) + '</div>';
                    try {
                        var inp = document.querySelector('input[name="details[' + f.id + '][lugar]"]');
                        if (inp && inp.dataset.mapImage) {
                            h += '<div style="position:relative;width:100%;">';
                            h += '<img src="' + inp.dataset.mapImage + '" style="width:100%;max-height:88px;border-radius:4px;display:block;object-fit:cover;border:1px solid #e6eef9;">';
                            h += '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:18px;filter:drop-shadow(0 1px 3px rgba(0,0,0,0.7));">\uD83D\uDCCD</div>';
                            h += '</div>';
                        }
                        if (inp && inp.dataset.mapsUrl) {
                            h += '<div style="font-size:9px;color:#0055a5;margin-top:3px;word-break:break-all;">' + escapeHtml(inp.dataset.mapsUrl) + '</div>';
                        }
                    } catch (ex) { }
                    return h;
                }
                // Obtener logo (intentar desde header) y membrete
                var logoSrc = '';
                try { var logoEl = document.querySelector('.report-header .left img'); if (logoEl) logoSrc = logoEl.getAttribute('src'); } catch (e) { }
                // Inline SVG fallback logo (se mostrar√° si no se puede cargar la imagen externa)
                var inlineLogo = '<svg xmlns="http://www.w3.org/2000/svg" width="240" height="90" viewBox="0 0 240 90">'
                    + '<rect width="100%" height="100%" fill="#007acc" rx="8" />'
                    + '<g transform="translate(16,15)">' + '<circle cx="30" cy="30" r="24" fill="#fff" />'
                    + '<text x="30" y="36" font-family="Arial, sans-serif" font-size="18" fill="#007acc" font-weight="bold" text-anchor="middle">LOGO</text>'
                    + '</g>'
                    + '<text x="130" y="46" font-family="Arial, sans-serif" font-size="24" fill="#ffffff">Nombre Empresa</text>'
                    + '</svg>';

                // Obtener l√≠neas del membrete (omitir la l√≠nea de fecha en el header)
                var membreteLines = [];
                try {
                    var metaDivs = document.querySelectorAll('.report-header .meta > div');
                    metaDivs.forEach(function (d) {
                        // Omitir divs que contengan la fecha principal
                        if (d.querySelector && d.querySelector('#report-date')) return;
                        // Omitir controles de UI (ej. boton 'Limpiar guardado') para que no aparezcan en el PDF
                        if (d.querySelector && d.querySelector('button')) return;
                        var txt = d.textContent.trim(); if (txt) membreteLines.push(txt);
                    });
                } catch (e) { }

                // Header: membrete izquierda, logo+titulo centrado, UTC+folio derecha (UTC sin leyenda)
                html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                // membrete (izq)
                html += '<div style="min-width:180px;">';
                if (membreteLines.length) { html += '<div style="font-size:12px;color:#1f2937;line-height:1.1">'; membreteLines.forEach(function (line) { html += '<div>' + line + '</div>'; }); html += '</div>'; }
                html += '</div>';

                // centro: logo sobre t√≠tulo (centrado)
                html += '<div style="flex:1;text-align:center;padding:0 12px">';
                if (logoSrc) { html += '<img src="' + logoSrc + '" style="height:120px;display:block;margin:0 auto 8px">'; }
                else { html += inlineLogo; }
                html += '<h2 style="color:#0b66c3;margin:0;font-size:18px;">Reporte de Inspecci√≥n en √Årea de Movimiento y Maniobras</h2>';
                html += '</div>';

                // derecha: UTC time (hora) con fecha debajo, y folio
                html += '<div style="text-align:right;color:#6b7280;font-size:12px;min-width:120px">';
                html += '<div><strong>' + utcTimeStr + '</strong></div>';
                html += '<div style="font-size:12px;color:#6b7280;margin-top:6px">' + utcDateStr + '</div>';
                html += '<div style="margin-top:8px;color:#374151;font-weight:600">Folio: ' + (folio || '') + '</div>';
                html += '</div>';
                html += '</div>';

                // Mostrar Tipo, Turno, Responsable, Cargo y Fecha distribuidos horizontalmente (flex)
                html += '<div style="display:flex;justify-content:center;gap:18px;flex-wrap:wrap;margin-top:12px;align-items:center">';
                // helper: small vertical separator
                var sep = '<div style="width:1px;height:28px;background:#e6eef9;margin:0 8px;display:inline-block;vertical-align:middle"></div>';
                html += '<div style="min-width:140px;text-align:center;font-size:13px;color:#374151">Tipo de Inspecci√≥n<br><strong>' + (tiposText || '-') + '</strong></div>';
                html += sep;
                html += '<div style="min-width:120px;text-align:center;font-size:13px;color:#374151">Turno<br><strong>' + (turnoText || '-') + '</strong></div>';
                html += sep;
                html += '<div style="min-width:140px;text-align:center;font-size:13px;color:#374151">Responsable<br><strong>' + (autor || '-') + '</strong></div>';
                html += sep;
                html += '<div style="min-width:140px;text-align:center;font-size:13px;color:#374151">Cargo<br><strong>' + (cargo || '-') + '</strong></div>';
                html += sep;
                html += '<div style="min-width:120px;text-align:center;font-size:13px;color:#374151">Fecha<br><strong>' + fecha + '</strong></div>';
                html += '</div>';
                html += '<hr style="border:none;border-top:1px solid #e6eef9;margin:12px 0">';
                // A√±adir columnas: Item | Informaci√≥n | Observaciones | Lugar
                html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                html += '<thead><tr>' +
                    '<th style="text-align:left;padding:8px;border-bottom:1px solid #e6eef9;width:24%">Item</th>' +
                    '<th style="text-align:left;padding:8px;border-bottom:1px solid #e6eef9;width:36%">Informaci√≥n</th>' +
                    '<th style="text-align:left;padding:8px;border-bottom:1px solid #e6eef9;width:20%">Observaciones</th>' +
                    '<th style="text-align:left;padding:8px;border-bottom:1px solid #e6eef9;width:20%">Lugar</th>' +
                    '</tr></thead>';
                html += '<tbody>';
                filled.forEach(function (f) {
                    var infoHtml = '';
                    var observacionesVal = '';
                    var lugarVal = '';
                    if (f.fields && f.fields.length) {
                        // Mapas de colores para prioridad y condici√≥n
                        var prioColor = { '1': '#28a745', '2': '#ffc107', '3': '#ff8c00' };
                        var condColor = { 'Satisfactorio': '#28a745', 'No Satisfactorio': '#dc3545', 'N/A': '#6c757d' };
                        function colorDot(c) { return '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:' + c + ';margin-left:8px;vertical-align:middle;"></span>'; }
                        infoHtml = '<ul style="margin:6px 0 6px 16px;padding:0;">';
                        f.fields.forEach(function (ff) {
                            var key = (ff.key || '').toString();
                            var val = (ff.value || '').toString();
                            // detectar observaciones y lugar (se mostrar√°n en columnas separadas)
                            if (/observac/i.test(key)) {
                                observacionesVal = val;
                                return; // no incluir en Informaci√≥n
                            }
                            if (/^lugar$/i.test(key)) {
                                lugarVal = val;
                                return; // no incluir en Informaci√≥n
                            }
                            var dot = '';
                            try {
                                if (/prioridad/i.test(key)) {
                                    if (prioColor[val]) dot = colorDot(prioColor[val]);
                                } else if (/condici/i.test(key)) {
                                    if (condColor[val]) dot = colorDot(condColor[val]);
                                }
                            } catch (e) { }
                            infoHtml += '<li style="margin-bottom:4px;">' + key + ': ' + val + (dot ? ' ' + dot : '') + '</li>';
                        });
                        infoHtml += '</ul>';
                    } else infoHtml = '<span class="muted">Sin campos adicionales</span>';
                    // Formar fila con las cuatro columnas
                    html += '<tr>' +
                        '<td style="vertical-align:top;padding:10px;border-bottom:1px solid #f0f6ff;font-weight:600">' + f.name + '</td>' +
                        '<td style="vertical-align:top;padding:10px;border-bottom:1px solid #f0f6ff">' + infoHtml + '</td>' +
                        '<td style="vertical-align:top;padding:10px;border-bottom:1px solid #f0f6ff">' + (observacionesVal ? ('<div style="white-space:pre-wrap;">' + escapeHtml(observacionesVal) + '</div>') : '<span class="muted">-</span>') + '</td>' +
                        '<td style="vertical-align:top;padding:10px;border-bottom:1px solid #f0f6ff">' + buildLugarHtml(f, lugarVal) + '</td>' +
                        '</tr>';
                });
                html += '</tbody></table>';

                // Recuadros de firma: AIFA y AFAC (AIFA muestra Responsable)
                html += '<div style="display:flex;justify-content:space-between;gap:24px;margin-top:22px">';
                html += '<div style="flex:1;border:1px solid #e6eef9;padding:14px;border-radius:6px;min-height:120px;display:flex;flex-direction:column;justify-content:space-between">';
                html += '<div style="font-size:13px;color:#17325a;text-align:center;font-weight:700">AIFA</div>';
                html += '<div>';
                html += '<div style="border-top:1px solid #cbdcec;margin-bottom:6px;padding-top:4px;text-align:center;color:#17325a">Firma</div>';
                html += '<div style="font-size:12px;color:#374151;text-align:center;font-weight:600">' + (autor || '-') + '</div>';
                html += '<div style="font-size:11px;color:#6b7280;text-align:center">' + (cargo || '-') + '</div>';
                html += '</div>';
                html += '</div>';
                html += '<div style="flex:1;border:1px solid #e6eef9;padding:14px;border-radius:6px;min-height:120px;display:flex;flex-direction:column;justify-content:space-between">';
                html += '<div style="font-size:13px;color:#17325a;text-align:center;font-weight:700">AFAC</div>';
                html += '<div style="border-top:1px solid #cbdcec;margin-top:10px;padding-top:8px;text-align:center;color:#17325a">Firma</div>';
                html += '</div>';
                html += '</div>';

                html += '<p style="margin-top:18px;font-size:12px;color:#6b7280">Generado desde el formulario interno.</p>';
                html += '</div>'; // fin primera p√°gina

                container.innerHTML = html;
                container.style.display = 'block';

                // Generar filename con fecha
                var fnameDate = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                var filename = 'Reporte-' + fnameDate + '.pdf';

                // Opciones de html2pdf
                var opt = {
                    margin: 10,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Generar y forzar descarga.
                // Primero intentar precargar el logo (si existe) para evitar errores CORS/imagen rota.
                (function generatePdf() {
                    var img = container.querySelector('img');
                    if (img && img.src) {
                        var testImg = new Image();
                        // intentar con crossOrigin para permitir html2canvas usarla
                        try { testImg.crossOrigin = 'Anonymous'; } catch (e) { }
                        var cleaned = false;
                        var timeout = setTimeout(function () {
                            // si tarda demasiado, eliminar la imagen y continuar
                            if (img && img.parentNode) { img.parentNode.removeChild(img); cleaned = true; }
                            proceed();
                        }, 3000);
                        testImg.onload = function () { clearTimeout(timeout); proceed(); };
                        testImg.onerror = function () { clearTimeout(timeout); if (img && img.parentNode) { img.parentNode.removeChild(img); cleaned = true; } proceed(); };
                        // arrancar la carga
                        try { testImg.src = img.src; } catch (e) { clearTimeout(timeout); if (img && img.parentNode) { img.parentNode.removeChild(img); } proceed(); }
                    } else {
                        proceed();
                    }

                    function proceed() {
                        var spinner = document.getElementById('pdf-spinner');
                        var preview = document.getElementById('pdf-preview-container');
                        var submitBtn = form.querySelector('input[type="submit"]');
                        try { if (spinner) spinner.style.display = 'flex'; if (submitBtn) { submitBtn.disabled = true; } } catch (e) { }

                        function finalizePdf() {
                            try {
                                // Generar el PDF y obtener el objeto jsPDF para crear un Blob
                                html2pdf().set(opt).from(container).toPdf().get('pdf').then(async function (pdf) {

                                    // ‚îÄ‚îÄ‚îÄ P√°gina 2: Mapa del aer√≥dromo en HORIZONTAL (landscape A4) ‚îÄ‚îÄ‚îÄ
                                    try {
                                        if (apCanvas && apCanvas.width > 0) {
                                            pdf.addPage([297, 210], 'l'); // A4 apaisado
                                            // Imagen: ocupa toda la p√°gina sin t√≠tulo
                                            var mapImgData = apCanvas.toDataURL('image/jpeg', 0.94);
                                            // A4 landscape: 297√ó210mm. Sin margen superior para m√°ximo espacio
                                            pdf.addImage(mapImgData, 'JPEG', 4, 4, 289, 202);
                                        }
                                    } catch (mapErr) { console.warn('Error agregando p√°gina de mapa landscape:', mapErr); }
                                    // ‚îÄ‚îÄ‚îÄ fin mapa landscape ‚îÄ‚îÄ‚îÄ

                                    // ‚îÄ‚îÄ‚îÄ P√°gina de Evidencias Fotogr√°ficas ‚îÄ‚îÄ‚îÄ
                                    try {
                                        var photoPageItems = [];
                                        filled.forEach(function (f, idx) {
                                            var photos = (window.mhr && window.mhr.getItemPhotos) ? window.mhr.getItemPhotos(f.id) : [];
                                            if (photos && photos.length > 0) {
                                                photoPageItems.push({ f: f, itemNum: idx + 1, photos: photos });
                                            }
                                        });
                                        if (photoPageItems.length > 0) {
                                            pdf.addPage([210, 297], 'p'); // A4 portrait
                                            var MARGIN_P = 14;
                                            var PAGE_H = 287;
                                            var PHOTO_W = 82;
                                            var PHOTO_H = 60;
                                            var COL_GAP = 8;
                                            var COLS_P = 2;
                                            // Encabezado de p√°gina
                                            pdf.setFontSize(15); pdf.setFont('helvetica', 'bold');
                                            pdf.setTextColor(23, 50, 90);
                                            pdf.text('Evidencias Fotogr\u00E1ficas', 105, 18, { align: 'center' });
                                            pdf.setFontSize(9); pdf.setFont('helvetica', 'normal');
                                            pdf.setTextColor(110, 110, 110);
                                            pdf.text('Fotograf\u00EDas adjuntas por \u00EDtem de inspecci\u00F3n', 105, 26, { align: 'center' });
                                            var yP = 36;
                                            var colXP = [MARGIN_P, MARGIN_P + PHOTO_W + COL_GAP];
                                            photoPageItems.forEach(function (item) {
                                                // Encabezado del item
                                                if (yP > PAGE_H - 30) { pdf.addPage([210, 297], 'p'); yP = 20; }
                                                pdf.setFontSize(11); pdf.setFont('helvetica', 'bold');
                                                pdf.setTextColor(23, 50, 90);
                                                pdf.text('Item ' + item.itemNum + ': ' + item.f.name, MARGIN_P, yP);
                                                pdf.setDrawColor(210, 228, 248); pdf.setLineWidth(0.4);
                                                pdf.line(MARGIN_P, yP + 2, 196, yP + 2);
                                                yP += 10;
                                                var col = 0;
                                                var rowH = 0;
                                                item.photos.forEach(function (photo, pIdx) {
                                                    if (yP + PHOTO_H + 14 > PAGE_H - 8) {
                                                        if (col > 0) { yP += rowH + 4; col = 0; rowH = 0; }
                                                        pdf.addPage([210, 297], 'p'); yP = 20;
                                                        pdf.setFontSize(9); pdf.setFont('helvetica', 'italic');
                                                        pdf.setTextColor(100, 100, 100);
                                                        pdf.text('Item ' + item.itemNum + ' \u2013 ' + item.f.name + ' (cont.)', MARGIN_P, yP); yP += 8;
                                                    }
                                                    try {
                                                        var fmt = 'JPEG';
                                                        if (photo.dataURL && photo.dataURL.indexOf('data:image/png') === 0) fmt = 'PNG';
                                                        pdf.addImage(photo.dataURL, fmt, colXP[col], yP, PHOTO_W, PHOTO_H, '', 'MEDIUM');
                                                        pdf.setFontSize(7.5); pdf.setFont('helvetica', 'normal');
                                                        pdf.setTextColor(90, 90, 90);
                                                        var photoLabel = 'Foto ' + (pIdx + 1);
                                                        if (photo.name) photoLabel += ' \u2013 ' + photo.name.substring(0, 32);
                                                        pdf.text(photoLabel, colXP[col], yP + PHOTO_H + 4.5);
                                                        rowH = Math.max(rowH, PHOTO_H + 8);
                                                    } catch (imgE) { console.warn('Error imagen en PDF:', imgE); }
                                                    col++;
                                                    if (col >= COLS_P) { col = 0; yP += rowH + 4; rowH = 0; }
                                                });
                                                if (col > 0) { yP += rowH + 4; }
                                                yP += 10;
                                            });
                                        }
                                    } catch (photoErr) { console.warn('Error generando p\u00E1gina de evidencias:', photoErr); }
                                    // ‚îÄ‚îÄ‚îÄ fin evidencias fotogr√°ficas ‚îÄ‚îÄ‚îÄ

                                    // ‚îÄ‚îÄ‚îÄ P√°gina extra: Ubicaciones con enlaces clickeables ‚îÄ‚îÄ‚îÄ
                                    try {
                                        var locationItems = filled.filter(function (f) {
                                            var inp = document.querySelector('input[name="details[' + f.id + '][lugar]"]');
                                            return inp && inp.dataset.lat;
                                        });
                                        if (locationItems.length > 0) {
                                            pdf.addPage();
                                            pdf.setFontSize(15); pdf.setFont('helvetica', 'bold');
                                            pdf.setTextColor(23, 50, 90);
                                            pdf.text('Ubicaciones de Hallazgos', 105, 20, { align: 'center' });
                                            pdf.setFontSize(8.5); pdf.setFont('helvetica', 'normal');
                                            pdf.setTextColor(110, 110, 110);
                                            pdf.text('Haga clic en cada enlace para ver la ubicaci\u00F3n exacta en Google Maps (vista satelital)', 105, 28, { align: 'center' });
                                            var locY = 42;
                                            locationItems.forEach(function (f, idx) {
                                                var inp = document.querySelector('input[name="details[' + f.id + '][lugar]"]');
                                                if (!inp) return;
                                                if (locY > 260) { pdf.addPage(); locY = 20; }
                                                // Nombre del hallazgo
                                                pdf.setFontSize(11); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(23, 50, 90);
                                                pdf.text((idx + 1) + '. ' + f.name, 20, locY); locY += 7;
                                                // Coordenadas
                                                pdf.setFontSize(9); pdf.setFont('helvetica', 'normal'); pdf.setTextColor(55, 65, 81);
                                                pdf.text('Coordenadas: ' + inp.dataset.lat + ', ' + inp.dataset.lng, 25, locY); locY += 6;
                                                // Enlace clickeable
                                                pdf.setTextColor(0, 85, 165);
                                                pdf.textWithLink('\u2192 Ver ubicaci\u00F3n en Google Maps (Vista Satelital)', 25, locY, { url: inp.dataset.mapsUrl });
                                                pdf.setTextColor(0, 0, 0); locY += 5;
                                                // URL visible como texto gris
                                                pdf.setFontSize(7); pdf.setTextColor(140, 140, 140);
                                                pdf.text(inp.dataset.mapsUrl, 25, locY);
                                                pdf.setFontSize(9); pdf.setTextColor(0, 0, 0);
                                                // Separador
                                                pdf.setDrawColor(210, 228, 248); pdf.setLineWidth(0.3);
                                                locY += 6; pdf.line(20, locY, 190, locY); locY += 8;
                                            });
                                        }
                                    } catch (locErr) { console.warn('Error generando p\u00E1gina de ubicaciones:', locErr); }
                                    // ‚îÄ‚îÄ‚îÄ fin ubicaciones ‚îÄ‚îÄ‚îÄ

                                    // Obtener blob
                                    var blob;
                                    try { blob = pdf.output('blob'); }
                                    catch (e) {
                                        try { var ab = pdf.output('arraybuffer'); blob = new Blob([ab], { type: 'application/pdf' }); }
                                        catch (err) { console.error('No se pudo obtener blob del PDF', err); blob = null; }
                                    }

                                    // Subir a Supabase y Guardar Datos
                                    if (blob) {
                                        try {
                                            if (submitBtn) {
                                                if (submitBtn.tagName === 'BUTTON') submitBtn.textContent = 'Subiendo reporte...';
                                                else submitBtn.value = 'Subiendo reporte...';
                                            }

                                            var pdfUrl = await uploadPdfToSupabase(blob, folio);

                                            if (submitBtn) {
                                                if (submitBtn.tagName === 'BUTTON') submitBtn.textContent = 'Guardando datos...';
                                                else submitBtn.value = 'Guardando datos...';
                                            }

                                            try {
                                                // Evitar bloqueo infinito: esperar m√°ximo 10s
                                                var savePromise = saveToSupabase(pdfUrl);
                                                var timeout = new Promise(function (_, reject) { setTimeout(function () { reject(new Error('timeout')); }, 10000); });
                                                var reportId = await Promise.race([savePromise, timeout]);
                                                if (!reportId) {
                                                    console.warn('saveToSupabase devolvi√≥ null o undefined.');
                                                    alert('Atenci√≥n: No se pudo guardar el reporte en la base de datos. Revisa la consola para m√°s detalles.');
                                                } else {
                                                    console.log('Reporte guardado con ID:', reportId);
                                                }
                                            } catch (e) {
                                                if (e && e.message === 'timeout') {
                                                    console.error('Timeout guardando en la base de datos.');
                                                    alert('El guardado en la base de datos tard√≥ demasiado y fue cancelado. El PDF se gener√≥ localmente.');
                                                } else {
                                                    console.error('Error guardando en DB:', e);
                                                    alert('Error guardando en la base de datos: ' + (e && e.message ? e.message : JSON.stringify(e)));
                                                }
                                            }

                                        } catch (e) {
                                            console.error('Error en proceso de guardado:', e);
                                        }
                                    } else {
                                        // Fallback si no hay blob, intentar guardar sin PDF URL (con timeout)
                                        try {
                                            var savePromise2 = saveToSupabase(null);
                                            var timeout2 = new Promise(function (_, reject) { setTimeout(function () { reject(new Error('timeout')); }, 10000); });
                                            var reportId2 = await Promise.race([savePromise2, timeout2]);
                                            if (!reportId2) {
                                                console.warn('No se guard√≥ el reporte (fallback).');
                                            }
                                        } catch (e) {
                                            console.error('Error guardando sin PDF:', e);
                                        }
                                    }

                                    try {
                                        if (spinner) spinner.style.display = 'none';
                                        if (submitBtn) {
                                            submitBtn.disabled = false;
                                            if (originalBtnText) {
                                                if (submitBtn.tagName === 'BUTTON') submitBtn.textContent = originalBtnText;
                                                else submitBtn.value = originalBtnText;
                                            }
                                        }
                                    } catch (e) { }

                                    if (!blob) { alert('No se pudo generar el PDF correctamente.'); return; }
                                    var url = URL.createObjectURL(blob);
                                    var iframe = document.getElementById('pdf-preview-frame');
                                    var downloadBtn = document.getElementById('pdf-download-btn');
                                    var closeBtn = document.getElementById('pdf-preview-close');
                                    // revocar URL anterior si existe
                                    try { if (preview._currentUrl) { URL.revokeObjectURL(preview._currentUrl); } } catch (e) { }
                                    preview._currentUrl = url;
                                    iframe.src = url;
                                    preview.style.display = 'block';
                                    preview.setAttribute('aria-hidden', 'false');
                                    // asignar descarga
                                    downloadBtn.onclick = function () {
                                        var a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
                                    };
                                    // cerrar vista previa
                                    closeBtn.onclick = function () {
                                        preview.style.display = 'none'; iframe.src = ''; try { if (preview._currentUrl) { URL.revokeObjectURL(preview._currentUrl); delete preview._currentUrl; } } catch (e) { }
                                    };
                                }).catch(function (err) {
                                    try {
                                        if (spinner) spinner.style.display = 'none';
                                        if (submitBtn) {
                                            submitBtn.disabled = false;
                                            if (originalBtnText) {
                                                if (submitBtn.tagName === 'BUTTON') submitBtn.textContent = originalBtnText;
                                                else submitBtn.value = originalBtnText;
                                            }
                                        }
                                    } catch (e) { }
                                    console.error('Error generando PDF', err);
                                    alert('Ocurri√≥ un error al generar el PDF. Revisa la consola.');
                                });
                            } catch (e) {
                                try { if (spinner) spinner.style.display = 'none'; if (submitBtn) submitBtn.disabled = false; } catch (err) { }
                                console.error('Excepci√≥n al invocar html2pdf', e);
                                alert('Ocurri√≥ un error al generar el PDF. Revisa la consola.');
                            }
                        } // End finalizePdf

                        // Canvas offscreen para mapa landscape (A4 horizontal: 297√ó210mm ‚Üí ratio 1.553 con m√°rgenes)
                        var apCanvas = document.createElement('canvas');
                        var CW = 1600, CH = 1030;
                        apCanvas.width = CW; apCanvas.height = CH;
                        if (true) {
                            var BBOX = { minLng: -99.0520, maxLng: -98.9760, minLat: 19.7210, maxLat: 19.7750 };
                            var ctx2d = apCanvas.getContext('2d');
                            // Colectar puntos marcados
                            var apPoints = [];
                            filled.forEach(function (f2, f2Idx) {
                                var inp2 = document.querySelector('input[name="details[' + f2.id + '][lugar]"]');
                                if (inp2 && inp2.dataset.lat && inp2.dataset.lng) {
                                    apPoints.push({ lat: parseFloat(inp2.dataset.lat), lng: parseFloat(inp2.dataset.lng), num: f2Idx + 1, name: f2.name });
                                }
                            });
                            function toPixel(lat, lng) {
                                return {
                                    x: (lng - BBOX.minLng) / (BBOX.maxLng - BBOX.minLng) * CW,
                                    y: (BBOX.maxLat - lat) / (BBOX.maxLat - BBOX.minLat) * CH
                                };
                            }
                            function drawAirportMarkers() {
                                apPoints.forEach(function (p) {
                                    var px = toPixel(p.lat, p.lng);
                                    ctx2d.save();
                                    ctx2d.shadowColor = 'rgba(0,0,0,0.65)'; ctx2d.shadowBlur = 8; ctx2d.shadowOffsetX = 2; ctx2d.shadowOffsetY = 3;
                                    ctx2d.beginPath(); ctx2d.arc(px.x, px.y, 17, 0, Math.PI * 2);
                                    ctx2d.fillStyle = '#dc2626'; ctx2d.fill();
                                    ctx2d.strokeStyle = '#ffffff'; ctx2d.lineWidth = 3; ctx2d.stroke();
                                    ctx2d.restore();
                                    ctx2d.fillStyle = '#ffffff'; ctx2d.font = 'bold 14px Arial';
                                    ctx2d.textAlign = 'center'; ctx2d.textBaseline = 'middle';
                                    ctx2d.fillText(String(p.num), px.x, px.y);
                                });
                                // Leyenda en banda semitransparente al fondo del canvas
                                if (apPoints.length > 0) {
                                    var bandH = 46;
                                    ctx2d.fillStyle = 'rgba(5,15,40,0.72)';
                                    ctx2d.fillRect(0, CH - bandH, CW, bandH);
                                    var lx = 14, ly = CH - bandH + 14;
                                    apPoints.forEach(function (p) {
                                        if (lx + 160 > CW) { lx = 14; ly += 20; }
                                        // c√≠rculo peque√±o
                                        ctx2d.beginPath(); ctx2d.arc(lx + 7, ly, 8, 0, Math.PI * 2);
                                        ctx2d.fillStyle = '#dc2626'; ctx2d.fill();
                                        ctx2d.strokeStyle = '#fff'; ctx2d.lineWidth = 1.5; ctx2d.stroke();
                                        ctx2d.fillStyle = '#fff'; ctx2d.font = 'bold 9px Arial';
                                        ctx2d.textAlign = 'center'; ctx2d.textBaseline = 'middle';
                                        ctx2d.fillText(String(p.num), lx + 7, ly);
                                        // nombre
                                        ctx2d.fillStyle = '#f0f6ff'; ctx2d.font = '11px Arial';
                                        ctx2d.textAlign = 'left'; ctx2d.textBaseline = 'middle';
                                        var label = p.name || '';
                                        ctx2d.fillText(label, lx + 20, ly);
                                        lx += 22 + ctx2d.measureText(label).width + 18;
                                    });
                                }
                            }
                            var esriAirportUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/export' +
                                '?bbox=' + BBOX.minLng + ',' + BBOX.minLat + ',' + BBOX.maxLng + ',' + BBOX.maxLat +
                                '&bboxSR=4326&imageSR=4326&size=' + CW + ',' + CH + '&format=jpg&f=image';
                            fetch(esriAirportUrl)
                                .then(function (r) { return r.blob(); })
                                .then(function (imgBlob) {
                                    var blobUrl = URL.createObjectURL(imgBlob);
                                    var satImg = new Image();
                                    satImg.onload = function () {
                                        ctx2d.drawImage(satImg, 0, 0, CW, CH);
                                        URL.revokeObjectURL(blobUrl);
                                        drawAirportMarkers();
                                        finalizePdf();
                                    };
                                    satImg.onerror = function () {
                                        ctx2d.fillStyle = '#1e3a5f'; ctx2d.fillRect(0, 0, CW, CH);
                                        ctx2d.fillStyle = '#94a3b8'; ctx2d.font = '18px Arial'; ctx2d.textAlign = 'center'; ctx2d.textBaseline = 'middle';
                                        ctx2d.fillText('Imagen sat√©lital no disponible', CW / 2, CH / 2);
                                        drawAirportMarkers(); finalizePdf();
                                    };
                                    satImg.src = blobUrl;
                                })
                                .catch(function (e) {
                                    console.error('Error cargando imagen del aer√≥dromo:', e);
                                    ctx2d.fillStyle = '#1e3a5f'; ctx2d.fillRect(0, 0, CW, CH);
                                    ctx2d.fillStyle = '#94a3b8'; ctx2d.font = '18px Arial'; ctx2d.textAlign = 'center'; ctx2d.textBaseline = 'middle';
                                    ctx2d.fillText('Imagen sat√©lital no disponible', CW / 2, CH / 2);
                                    drawAirportMarkers(); finalizePdf();
                                });
                        } else {
                            finalizePdf();
                        }
                    }
                })();
            });
        });
    </script>

    <script>
        (function () {
            var STORAGE_KEY = 'mhr_form_state_v1';
            var saveTimer = null;
            function getFieldKey(el) {
                if (el.id) return 'id::' + el.id;
                if (el.name) return 'name::' + el.name;
                return null;
            }

            function collectState() {
                var state = { counters: {}, fields: {} };
                // counters for duplicates (if available)
                try { if (window.mhr && window.mhr.counters) { state.counters = Object.assign({}, window.mhr.counters); } } catch (e) { }

                // store all inputs/selects/textareas
                Array.prototype.slice.call(document.querySelectorAll('input,textarea,select')).forEach(function (el) {
                    var key = getFieldKey(el);
                    if (!key) return;
                    var rec = { disabled: !!el.disabled };
                    if (el.type === 'checkbox' || el.type === 'radio') rec.checked = !!el.checked;
                    else rec.value = el.value;
                    state.fields[key] = rec;
                });
                return state;
            }

            function saveState() {
                try {
                    var s = collectState();
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
                } catch (e) { console.error('Error guardando estado', e); }
            }

            function saveDebounced() { if (saveTimer) clearTimeout(saveTimer); saveTimer = setTimeout(saveState, 300); }

            function restoreState() {
                try {
                    var raw = localStorage.getItem(STORAGE_KEY);
                    if (!raw) return;
                    var state = JSON.parse(raw);
                    // recreate duplicates
                    if (state.counters && window.mhr && typeof window.mhr.duplicateItem === 'function') {
                        Object.keys(state.counters).forEach(function (origId) {
                            var count = parseInt(state.counters[origId], 10) || 0;
                            // Count existing clones in DOM for this origId (ids like origId_dup...)
                            try {
                                var existingNodes = Array.prototype.slice.call(document.querySelectorAll('input[type="checkbox"][id^="' + origId + '_dup"]'));
                                var existing = existingNodes.length;
                                if (existing < count) {
                                    var toCreate = Math.min(20, count - existing); // cap to avoid runaway
                                    for (var i = 0; i < toCreate; i++) { try { window.mhr.duplicateItem(origId); } catch (e) { console.warn('dup failed', origId, e); } }
                                } else if (existing > count) {
                                    // remove extra clones (from the end)
                                    var removeCount = existing - count;
                                    for (var r = 0; r < removeCount; r++) {
                                        var node = existingNodes.pop();
                                        if (!node) break;
                                        try {
                                            // remove the checkbox, its label, buttons and details panel if present
                                            var id = node.id;
                                            var parent = node.parentNode;
                                            // remove following label[for=id]
                                            var lbl = document.querySelector('label[for="' + id + '"]');
                                            if (lbl && lbl.parentNode) lbl.parentNode.removeChild(lbl);
                                            // remove buttons: done_, update_, dup_, clear_
                                            ['done_', 'update_', 'dup_', 'clear_'].forEach(function (pref) { var b = document.getElementById(pref + id); if (b && b.parentNode) b.parentNode.removeChild(b); });
                                            // remove details panel
                                            var det = document.getElementById('details_' + id);
                                            if (det && det.parentNode) det.parentNode.removeChild(det);
                                            // finally remove the checkbox itself
                                            if (node && node.parentNode) node.parentNode.removeChild(node);
                                        } catch (e) { console.warn('error removing extra clone', e); }
                                    }
                                }
                            } catch (e) { console.warn('error handling counters for', origId, e); }
                        });
                    }

                    // restore fields
                    if (state.fields) {
                        Object.keys(state.fields).forEach(function (k) {
                            var rec = state.fields[k];
                            if (k.indexOf('id::') === 0) {
                                var id = k.slice(4);
                                var el = document.getElementById(id);
                                if (!el) return;
                                try {
                                    if ('checked' in rec) el.checked = !!rec.checked;
                                    else if ('value' in rec) el.value = rec.value;
                                    el.disabled = !!rec.disabled;
                                    // trigger change events where relevant
                                    var ev = new Event('change', { bubbles: true }); el.dispatchEvent(ev);
                                } catch (e) { }
                            } else if (k.indexOf('name::') === 0) {
                                var name = k.slice(6);
                                var nodeList = document.querySelectorAll('[name="' + name.replace(/"/g, '\"') + '"]');
                                if (!nodeList || !nodeList.length) return;
                                var el = nodeList[0];
                                try {
                                    if (el.type === 'checkbox' || el.type === 'radio') {
                                        // set matching ones
                                        Array.prototype.slice.call(nodeList).forEach(function (n) { n.checked = !!rec.checked; });
                                    } else {
                                        nodeList.forEach(function (n) { n.value = rec.value; });
                                    }
                                    Array.prototype.slice.call(nodeList).forEach(function (n) { n.disabled = !!rec.disabled; n.dispatchEvent(new Event('change', { bubbles: true })); });
                                } catch (e) { }
                            }
                        });
                    }
                } catch (e) { console.error('Error restaurando estado', e); }
            }

            // wire save triggers
            document.addEventListener('input', saveDebounced);
            document.addEventListener('change', saveDebounced);
            // capture clicks that change structure (duplicate, done, update)
            document.addEventListener('click', function (e) {
                var t = e.target;
                if (!t) return;
                if (t.classList && (t.classList.contains('item-duplicate') || t.classList.contains('item-done') || t.classList.contains('item-update'))) {
                    // small delay to allow DOM updates
                    setTimeout(saveState, 200);
                }
            });

            // expose manual save (used by other scripts if needed)
            try { window.saveFormState = saveState; window.restoreFormState = restoreState; } catch (e) { }

            // restore on load (after a small delay to ensure duplicate API exposed)
            document.addEventListener('DOMContentLoaded', function () { setTimeout(restoreState, 100); });
        })();
    </script>

    <script>
        // Bot√≥n para limpiar el estado guardado en localStorage
        document.addEventListener('DOMContentLoaded', function () {
            var btn = document.getElementById('clear-saved-btn');
            if (!btn) return;
            btn.addEventListener('click', function () {
                if (!confirm('¬øBorrar el estado guardado? Esta acci√≥n no se puede deshacer.')) return;
                try {
                    localStorage.removeItem('mhr_form_state_v1');
                    alert('Estado guardado eliminado. Se recargar√° la p√°gina.');
                    location.reload();
                } catch (e) {
                    console.error('No se pudo borrar estado guardado', e);
                    alert('Ocurri√≥ un error al borrar el estado guardado. Revisa la consola.');
                }
            });
        });
    </script>

    <script>
        (function () {
            // Comportamiento para Cargo: botones estilo responsable
            var roleBtns = document.querySelectorAll('.role-item');
            var roleInput = document.getElementById('report-role-input');
            var roleOther = document.getElementById('report-role-other');
            var roleReset = document.getElementById('report-role-reset');
            if (roleBtns && roleBtns.length && roleInput && roleReset) {
                roleBtns.forEach(function (btn) {
                    btn.addEventListener('click', function () {
                        // ocultar los dem√°s y marcar seleccionado
                        roleBtns.forEach(function (b) { if (b !== btn) b.style.display = 'none'; else b.classList.add('selected'); });
                        roleInput.value = btn.getAttribute('data-value') || btn.textContent.trim();
                        roleReset.style.display = 'inline-block';
                        if (roleInput.value === 'Otro') { roleOther.style.display = 'block'; }
                        else { roleOther.style.display = 'none'; roleOther.value = ''; }
                    });
                });
                roleReset.addEventListener('click', function () {
                    roleBtns.forEach(function (b) { b.style.display = 'inline-block'; b.classList.remove('selected'); });
                    roleInput.value = '';
                    roleOther.style.display = 'none'; roleOther.value = '';
                    roleReset.style.display = 'none';
                });
            }
        })();
    </script>

    <script>
        (function () {
            // Nota: el comportamiento de Cargo es manejado por los botones '.role-item' (script independiente arriba)

            // Bloquear los checkboxes de tipo_reporte tras la primera selecci√≥n y permitir cambiar
            var itemIds = [
                'tipo_area_movimiento', 'tipo_franjas', 'tipo_iluminacion', 'tipo_marcas', 'tipo_ayudas',
                'tipo_obstaculos', 'tipo_combustibles', 'tipo_construccion', 'tipo_ssei', 'tipo_vehiculos',
                'tipo_fauna', 'tipo_proteccion'
            ];
            // Per-item Done/Update buttons: lock/unlock only the respective item
            var tipoEls = itemIds.map(function (id) { return document.getElementById(id); }).filter(Boolean);
            if (tipoEls.length) {
                itemIds.forEach(function (id) {
                    var chk = document.getElementById(id);
                    var doneBtn = document.getElementById('done_' + id);
                    var updateBtn = document.getElementById('update_' + id);
                    if (!chk) return;
                    function refresh() {
                        if (chk.disabled) {
                            if (doneBtn) doneBtn.style.display = 'none';
                            if (updateBtn) updateBtn.style.display = 'inline-block';
                        } else {
                            if (chk.checked) { if (doneBtn) doneBtn.style.display = 'inline-block'; } else { if (doneBtn) doneBtn.style.display = 'none'; }
                            if (updateBtn) updateBtn.style.display = 'none';
                        }
                    }
                    // show/hide done when checkbox changes
                    chk.addEventListener('change', function () { refresh(); });
                    // Done locks this checkbox and the detail panel fields
                    if (doneBtn) {
                        doneBtn.addEventListener('click', function () {
                            if (chk.checked) {
                                chk.disabled = true;
                                // disable all inputs/selects/textareas inside the detail panel
                                var det = document.getElementById('details_' + id);
                                if (det) {
                                    Array.prototype.slice.call(det.querySelectorAll('input, textarea, select')).forEach(function (el) {
                                        try { el.disabled = true; } catch (e) { }
                                    });
                                }
                            }
                            refresh();
                        });
                    }
                    // Update unlocks this checkbox and the detail panel fields for modification
                    if (updateBtn) {
                        updateBtn.addEventListener('click', function () {
                            chk.disabled = false;
                            // enable all inputs/selects/textareas inside the detail panel
                            var det = document.getElementById('details_' + id);
                            if (det) {
                                Array.prototype.slice.call(det.querySelectorAll('input, textarea, select')).forEach(function (el) {
                                    try { el.disabled = false; } catch (e) { }
                                });
                            }
                            refresh();
                        });
                    }
                    // initialize
                    refresh();
                });
            }
        })();
    </script>

    <script>
        (function () {
            // Mostrar campo "Otro" para Hallazgo cuando corresponda
            var itemIds = [
                'tipo_area_movimiento', 'tipo_franjas', 'tipo_iluminacion', 'tipo_marcas', 'tipo_ayudas',
                'tipo_obstaculos', 'tipo_combustibles', 'tipo_construccion', 'tipo_ssei', 'tipo_vehiculos',
                'tipo_fauna', 'tipo_proteccion'
            ];
            itemIds.forEach(function (id) {
                var sel = document.getElementById('hallazgo_' + id);
                var other = document.getElementById('hallazgo_other_' + id);
                if (!sel || !other) return;
                function update() {
                    if (sel.value === 'Otro') other.style.display = 'block';
                    else { other.style.display = 'none'; other.value = ''; }
                }
                sel.addEventListener('change', update);
                // inicializar estado
                update();
            });

            // Asegurarse de ocultar y limpiar "otro" si se desmarca el item
            itemIds.forEach(function (id) {

                var other = document.getElementById('hallazgo_other_' + id);
                if (!chk || !other) return;
                chk.addEventListener('change', function () {
                    if (!chk.checked) { other.style.display = 'none'; other.value = ''; }
                });
            });
        })();
    </script>

    <script>
        // Script para manejo del mapa interactivo para seleccionar Lugar
        (function () {
            var mapInstance = null;
            var selectedLatLng = null;
            var marker = null;
            var currentLugarField = null;

            function openMapModal(lugarInputEl) {
                console.log('openMapModal called with:', lugarInputEl);
                currentLugarField = lugarInputEl;
                selectedLatLng = null;

                var modal = document.getElementById('map-modal');
                if (!modal) {
                    console.error('map-modal element not found');
                    return;
                }

                modal.classList.add('open');

                // Inicializar mapa despu√©s de mostrar modal
                setTimeout(function () {
                    try {
                        if (!mapInstance) {
                            console.log('Initializing map...');
                            initMap();
                        } else {
                            console.log('Map already initialized, invalidating size...');
                        }
                        mapInstance.invalidateSize();
                    } catch (e) {
                        console.error('Error initializing map:', e);
                    }
                }, 150);
            }

            function closeMapModal() {
                var modal = document.getElementById('map-modal');
                if (modal) modal.classList.remove('open');
            }

            function initMap() {
                if (mapInstance) return;

                // Coordenadas por defecto (ser√°n sobrescritas por el KML)
                var defaultLat = 19.745;
                var defaultLng = -99.012;

                mapInstance = L.map('map', {
                    center: [defaultLat, defaultLng],
                    zoom: 15,
                    scrollWheelZoom: true
                });

                // Agregar capa de mapa
                // Vista satelital tipo Google Earth (ESRI World Imagery ‚Äî sin clave API)
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 20
                }).addTo(mapInstance);
                // Capa de etiquetas (nombres, calles, referencias) sobre el sat√©lite
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '',
                    maxZoom: 20,
                    opacity: 0.9
                }).addTo(mapInstance);

                // Centrar en el aer√≥dromo AIFA
                mapInstance.setView([19.7470, -99.0125], 15);

                // Listener para clicks en el mapa
                mapInstance.on('click', function (e) {
                    selectedLatLng = e.latlng;
                    if (marker) mapInstance.removeLayer(marker);
                    marker = L.marker(e.latlng, {
                        draggable: true
                    }).addTo(mapInstance);

                    // Actualizar info
                    updateMapInfo();
                });
            }

            function updateMapInfo() {
                if (!selectedLatLng) {
                    console.log('No selectedLatLng, skipping updateMapInfo');
                    return;
                }
                var infoEl = document.getElementById('map-info');
                if (infoEl) {
                    var infoText = '<strong>‚úì Ubicaci√≥n seleccionada:</strong><br>' +
                        'Latitud: ' + selectedLatLng.lat.toFixed(6) + '<br>' +
                        'Longitud: ' + selectedLatLng.lng.toFixed(6);
                    infoEl.innerHTML = infoText;
                    console.log('Map info updated:', infoText);
                }
            }

            function useMyLocation() {
                if (!navigator.geolocation) {
                    alert('Tu navegador no soporta geolocalizaci√≥n.');
                    return;
                }
                var gpsBtn = document.getElementById('map-gps-btn');
                var infoEl = document.getElementById('map-info');
                if (gpsBtn) { gpsBtn.disabled = true; gpsBtn.textContent = '‚è≥ Obteniendo...'; }
                if (infoEl) infoEl.innerHTML = '<em>Obteniendo tu ubicaci√≥n GPS, por favor espera‚Ä¶</em>';

                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        var lat = position.coords.latitude;
                        var lng = position.coords.longitude;
                        var accuracy = position.coords.accuracy;

                        selectedLatLng = L.latLng(lat, lng);

                        // Colocar / mover marcador
                        if (marker) mapInstance.removeLayer(marker);
                        marker = L.marker(selectedLatLng, { draggable: true }).addTo(mapInstance);
                        marker.on('dragend', function (ev) {
                            selectedLatLng = ev.target.getLatLng();
                            updateMapInfo();
                        });

                        // Centrar mapa en la ubicaci√≥n real
                        mapInstance.setView(selectedLatLng, 18);

                        // Mostrar info
                        if (infoEl) {
                            infoEl.innerHTML = '<strong>üìç Ubicaci√≥n GPS obtenida:</strong><br>' +
                                'Latitud: ' + lat.toFixed(6) + ' &nbsp; Longitud: ' + lng.toFixed(6) +
                                '<br><span style="font-size:11px;color:#6b7280">Precisi√≥n: ¬±' + Math.round(accuracy) + ' m &nbsp;¬∑&nbsp; Puedes arrastrar el marcador para ajustar.</span>';
                        }

                        if (gpsBtn) {
                            gpsBtn.disabled = false;
                            gpsBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/><circle cx="12" cy="12" r="9" opacity=".3"/></svg> Mi ubicaci√≥n actual';
                        }
                    },
                    function (err) {
                        var msg = {
                            1: 'Permiso de ubicaci√≥n denegado. Por favor permite el acceso en tu navegador.',
                            2: 'No se pudo determinar la posici√≥n (se√±al GPS insuficiente).',
                            3: 'Tiempo de espera agotado. Intenta de nuevo.'
                        }[err.code] || 'Error desconocido al obtener ubicaci√≥n.';
                        alert(msg);
                        if (infoEl) infoEl.innerHTML = '<strong>‚ùå ' + msg + '</strong>';
                        if (gpsBtn) {
                            gpsBtn.disabled = false;
                            gpsBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/><circle cx="12" cy="12" r="9" opacity=".3"/></svg> Mi ubicaci√≥n actual';
                        }
                    },
                    { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
                );
            }

            function confirmLocation() {
                console.log('confirmLocation called, selectedLatLng:', selectedLatLng, 'currentLugarField:', currentLugarField);

                if (!selectedLatLng) {
                    alert('Por favor selecciona una ubicaci√≥n en el mapa haciendo clic.');
                    return;
                }

                if (!currentLugarField) {
                    alert('Error: no hay campo Lugar seleccionado.');
                    return;
                }

                // Llenar el campo con coordenadas y guardar metadatos para el PDF
                var locationStr = selectedLatLng.lat.toFixed(6) + ', ' + selectedLatLng.lng.toFixed(6);
                currentLugarField.value = locationStr;
                currentLugarField.dataset.lat = selectedLatLng.lat.toFixed(6);
                currentLugarField.dataset.lng = selectedLatLng.lng.toFixed(6);
                currentLugarField.dataset.mapsUrl = 'https://maps.google.com/maps?q=' + selectedLatLng.lat.toFixed(6) + ',' + selectedLatLng.lng.toFixed(6) + '&t=k&z=17';

                // Disparar eventos de cambio para persistencia
                try {
                    currentLugarField.dispatchEvent(new Event('input'));
                    currentLugarField.dispatchEvent(new Event('change'));
                } catch (e) { console.error('Error disparando eventos:', e); }

                closeMapModal();
                selectedLatLng = null;
                if (marker) {
                    try { mapInstance.removeLayer(marker); } catch (e) { }
                }
                marker = null;
            }

            // Wiring botones del modal (con delay para asegurar que DOM est√© listo)
            setTimeout(function () {
                var closeBtn = document.getElementById('map-modal-close');
                var confirmBtn = document.getElementById('map-modal-confirm');
                var modal = document.getElementById('map-modal');

                var gpsBtn = document.getElementById('map-gps-btn');
                if (gpsBtn) {
                    gpsBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        useMyLocation();
                    });
                }

                if (closeBtn) {
                    closeBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        closeMapModal();
                    });
                }

                if (confirmBtn) {
                    confirmBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        confirmLocation();
                    });
                }

                if (modal) {
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) closeMapModal();
                    });
                }
            }, 100);

            // Exponer funci√≥n para abrir el modal
            window.openMapPicker = openMapModal;
        })();
    </script>

    <script>
        (function () {
            // Colorear selects de prioridad: 1=verde, 2=amarillo, 3=rojo
            var colorMap = { '1': '#28a745', '2': '#ffc107', '3': '#dc3545' };
            function updatePriorityColor(sel) {
                try {
                    var v = sel.value;
                    if (colorMap[v]) sel.style.backgroundColor = colorMap[v];
                    else sel.style.backgroundColor = '';
                } catch (e) { }
            }
            var prios = document.querySelectorAll('select.priority-select');
            prios.forEach(function (s) { s.addEventListener('change', function () { updatePriorityColor(s); }); updatePriorityColor(s); });
            // Si un panel se oculta (ya manejado antes), el color se limpia en esa rutina.
        })();
    </script>

    <script>
        (function () {
            // Colorear selects de Condici√≥n: Satisfactorio=verde, No Satisfactorio=rojo, N/A=gris
            var condMap = { 'Satisfactorio': '#28a745', 'No Satisfactorio': '#dc3545', 'N/A': '#6c757d' };
            function updateCondColor(sel) {
                try {
                    var v = sel.value;
                    if (condMap[v]) sel.style.backgroundColor = condMap[v];
                    else sel.style.backgroundColor = '';
                } catch (e) { }
            }
            var conds = document.querySelectorAll('select.condicion-select');
            conds.forEach(function (s) { s.addEventListener('change', function () { updateCondColor(s); }); updateCondColor(s); });
            // limpieza del color se realiza en las rutinas que ocultan/limpian los paneles
        })();
    </script>

    <!-- Modal del mapa interactivo para seleccionar Lugar -->
    <div id="map-modal">
        <div id="map-modal-content">
            <div id="map-modal-header">
                <h2 id="map-modal-title">Seleccionar Lugar en el Mapa</h2>
                <button id="map-modal-close" type="button">‚úï</button>
            </div>
            <div id="map-container">
                <div id="map"></div>
            </div>
            <div id="map-info">
                <strong>Haz clic en el mapa</strong> para seleccionar la ubicaci√≥n, o usa el bot√≥n <em>Mi ubicaci√≥n actual</em> para marcar donde est√°s.
            </div>
            <div id="map-modal-actions">
                <button id="map-gps-btn" type="button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3"/><circle cx="12" cy="12" r="9" opacity=".3"/></svg>
                    Mi ubicaci√≥n actual
                </button>
                <button id="map-modal-confirm" type="button">Confirmar Ubicaci√≥n</button>
            </div>
        </div>
    </div>

    <!-- Supabase Logic -->
    <script>
        (function () {
            // Configuraci√≥n de Supabase
            var SUPABASE_URL = 'https://pwvedjqknrwlebayeodd.supabase.co';
            var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3dmVkanFrbnJ3bGViYXllb2RkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwOTIwMDcsImV4cCI6MjA4MTY2ODAwN30.PDVUtOTYDdhQk25U9K-i6mZFJ2vIXHksEEQ9z2mMW5o';
            // ‚ö†Ô∏è ADVERTENCIA: La Service Role Key es secreta y potente. NO la expongas en producci√≥n. √ösala solo para pruebas.
            // Para producci√≥n, crea una Edge Function en Supabase para generar signed URLs de forma segura.
            var SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3dmVkanFrbnJ3bGViYXllb2RkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjA5MjAwNywiZXhwIjoyMDgxNjY4MDA3fQ.j9iwH161MBhjJXlc0eKmvMtUaFHSRQqZXsu4b1SJom4'; // Tu Service Role Key

            var supabase = null;
            var serviceSupabase = null; // Cliente con service key para operaciones administrativas
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                window.supabaseClient = supabase; // Exponer cliente globalmente
                if (SUPABASE_SERVICE_KEY && SUPABASE_SERVICE_KEY !== 'TU_SERVICE_ROLE_KEY_AQUI') {
                    serviceSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
                }
            } catch (e) {
                console.error('Error inicializando Supabase:', e);
                return;
            }

            var loginModal = document.getElementById('login-modal');
            var loginBtn = document.getElementById('login-btn');
            var emailInput = document.getElementById('login-email');
            var passInput = document.getElementById('login-password');
            var errorMsg = document.getElementById('login-error');
            var userInfo = document.getElementById('user-info');
            var userEmailSpan = document.getElementById('user-email');
            var userRoleSpan = document.getElementById('user-role');
            var logoutBtn = document.getElementById('logout-btn');
            var reportForm = document.getElementById('report-form');
            var reportHeader = document.querySelector('.report-header');
            var mainTitle = document.getElementById('main-title');

            // Ocultar formulario inicialmente
            if (reportForm) reportForm.style.display = 'none';
            if (reportHeader) reportHeader.style.display = 'none';
            if (mainTitle) mainTitle.style.display = 'none';
            document.body.classList.add('loading-auth');

            async function checkSession() {
                var { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    handleUser(session.user);
                } else {
                    showLogin();
                }
            }

            function showLogin() {
                if (loginModal) loginModal.style.display = 'flex';
                if (userInfo) userInfo.style.display = 'none';
                if (reportForm) reportForm.style.display = 'none';
                if (reportHeader) reportHeader.style.display = 'none';
                if (mainTitle) mainTitle.style.display = 'none';
                document.body.classList.add('loading-auth');
            }

            async function handleUser(user) {
                if (loginModal) loginModal.style.display = 'none';
                if (userInfo) userInfo.style.display = 'flex';
                if (userEmailSpan) userEmailSpan.textContent = user.email;

                // Mostrar contenido principal
                if (reportHeader) reportHeader.style.display = 'flex';
                if (mainTitle) mainTitle.style.display = 'block';
                document.body.classList.remove('loading-auth');

                // Obtener rol del usuario
                // Intentamos obtenerlo de 'user_metadata' primero, o de una tabla 'profiles'
                var role = 'viewer'; // default

                // 1. Check metadata
                if (user.user_metadata && user.user_metadata.role) {
                    role = user.user_metadata.role;
                } else {
                    // 2. Check profiles table (asumiendo tabla 'profiles' con columna 'role')
                    var { data, error } = await supabase
                        .from('profiles')
                        .select('role')
                        .eq('id', user.id)
                        .single();

                    if (data && data.role) {
                        role = data.role;
                    }
                }

                if (userRoleSpan) userRoleSpan.textContent = role;

                // L√≥gica de permisos basada en rol
                // Roles permitidos para editar: 'admin', 'editor', 'inspector'
                var allowedRoles = ['admin', 'editor', 'inspector', 'superuser'];

                if (allowedRoles.includes(role.toLowerCase())) {
                    if (reportForm) reportForm.style.display = 'block';
                } else {
                    alert('Tu usuario (' + role + ') no tiene permisos para llenar reportes.');
                    // Opcional: mostrar solo vista de lectura o mensaje
                }

                // Mostrar panel de admin si corresponde
                if (role.toLowerCase() === 'admin' || role.toLowerCase() === 'superuser') {
                    var adminPanel = document.getElementById('admin-panel');
                    if (adminPanel) {
                        adminPanel.style.display = 'block';
                        loadAdminReports();
                    }
                }
            }

            async function loadAdminReports() {
                var list = document.getElementById('admin-reports-list');
                if (!list) return;
                list.innerHTML = '<tr><td colspan="4">Cargando...</td></tr>';

                var { data, error } = await supabase
                    .from('reports')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) {
                    console.error('Error cargando reportes:', error);
                    list.innerHTML = '<tr><td colspan="4" style="color:red">Error cargando reportes</td></tr>';
                    return;
                }

                list.innerHTML = '';
                if (!data || data.length === 0) {
                    list.innerHTML = '<tr><td colspan="4">No hay reportes registrados.</td></tr>';
                    return;
                }

                for (const r of data) {
                    var tr = document.createElement('tr');
                    var pdfLink = '<span style="color:#9ca3af">Sin PDF</span>';

                    if (r.pdf_url && serviceSupabase) {
                        try {
                            var { data: signedData, error: signedError } = await serviceSupabase
                                .storage
                                .from('reports')
                                .createSignedUrl(r.pdf_url, 3600);

                            if (signedError) {
                                console.error('Error generando signed URL:', signedError);
                                pdfLink = '<span style="color:#ef4444">Error generando enlace</span>';
                            } else if (signedData && signedData.signedUrl) {
                                pdfLink = '<a href="' + signedData.signedUrl + '" target="_blank" class="admin-btn-view">üìÑ Ver PDF</a>';
                            } else {
                                pdfLink = '<span style="color:#9ca3af">No disponible</span>';
                            }
                        } catch (e) {
                            console.error('Excepci√≥n generando signed URL:', e);
                            pdfLink = '<span style="color:#ef4444">Error</span>';
                        }
                    } else if (r.pdf_url) {
                        var { data: publicData } = supabase
                            .storage
                            .from('reports')
                            .getPublicUrl(r.pdf_url);
                        pdfLink = publicData && publicData.publicUrl
                            ? '<a href="' + publicData.publicUrl + '" target="_blank" class="admin-btn-view">üìÑ Ver PDF</a>'
                            : '<span style="color:#9ca3af">No disponible</span>';
                    }

                    tr.innerHTML = '<td>' + (r.fecha_local || (r.created_at ? r.created_at.slice(0,10).split('-').reverse().join('/') + ' ' + r.created_at.slice(11,19) : '-')) + '</td>' +
                        '<td>' + (r.folio || '-') + '</td>' +
                        '<td>' + (r.responsable || '-') + '</td>' +
                        '<td>' + pdfLink + '</td>';
                    list.appendChild(tr);
                }
            }

            var refreshBtn = document.getElementById('refresh-admin-btn');
            if (refreshBtn) refreshBtn.addEventListener('click', loadAdminReports);

            if (loginBtn) {
                loginBtn.addEventListener('click', async function () {
                    var email = emailInput.value;
                    var password = passInput.value;
                    errorMsg.style.display = 'none';
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Entrando...';

                    var { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Entrar';

                    if (error) {
                        errorMsg.textContent = 'Error: ' + error.message;
                        errorMsg.style.display = 'block';
                    } else {
                        handleUser(data.user);
                    }
                });
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function () {
                    await supabase.auth.signOut();
                    location.reload();
                });
            }

            // Iniciar chequeo
            checkSession();

            // Tab switching functionality
            (function () {
                const tabs = document.querySelectorAll('.sidebar-tab');
                const sections = document.querySelectorAll('.content-section');

                tabs.forEach(tab => {
                    tab.addEventListener('click', function () {
                        const targetTab = this.getAttribute('data-tab');

                        // Remove active class from all tabs
                        tabs.forEach(t => t.classList.remove('active'));
                        // Add active class to clicked tab
                        this.classList.add('active');

                        // Hide all sections
                        sections.forEach(section => section.classList.remove('active'));
                        // Show target section
                        const targetSection = document.getElementById(targetTab + '-section');
                        if (targetSection) {
                            targetSection.classList.add('active');

                            // Load statistics when statistics tab is activated
                            if (targetTab === 'estadistica') {
                                loadEstadisticas();
                            }
                        }

                        // Hide sidebar after selecting a tab
                        document.body.classList.add('sidebar-hidden');
                    });
                });

                // Menu toggle button: show sidebar again
                var menuToggleBtn = document.getElementById('menu-toggle-btn');
                if (menuToggleBtn) {
                    menuToggleBtn.addEventListener('click', function () {
                        document.body.classList.remove('sidebar-hidden');
                    });
                }
            })();

            // Funci√≥n para cargar estad√≠sticas
            async function loadEstadisticas() {
                const client = window.supabaseClient;
                if (!client) {
                    console.error('Supabase client not ready');
                    return;
                }

                // Mostrar estado de carga
                ['inspection-types-chart','monthly-reports-chart'].forEach(function(id){
                    var el = document.getElementById(id);
                    if (el) el.innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">Cargando datos...</p>';
                });

                try {
                    const { data: reports, error } = await client
                        .from('reports')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) {
                        console.error('Error loading statistics:', error);
                        ['inspection-types-chart','monthly-reports-chart'].forEach(function(id){
                            var el = document.getElementById(id);
                            if (el) el.innerHTML = '<p style="color:#ef4444;text-align:center;padding:20px">Error al cargar datos: ' + error.message + '</p>';
                        });
                        return;
                    }

                    const totalReports = reports.length;
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();

                    const reportsThisMonth = reports.filter(function(r) {
                        const d = new Date(r.created_at);
                        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                    }).length;

                    // Prioridad promedio
                    let totalPriority = 0, priorityCount = 0;
                    reports.forEach(function(report) {
                        if (report.details) {
                            Object.values(report.details).forEach(function(detail) {
                                if (detail.prioridad && detail.prioridad !== 'N/A') {
                                    totalPriority += parseInt(detail.prioridad) || 0;
                                    priorityCount++;
                                }
                            });
                        }
                    });
                    const avgPriority = priorityCount > 0 ? (totalPriority / priorityCount).toFixed(1) : '‚Äî';

                    // Tasa de completitud
                    const completedReports = reports.filter(function(r){ return r.pdf_url; }).length;
                    const completionRate = totalReports > 0 ? Math.round((completedReports / totalReports) * 100) : 0;

                    // Actualizar tarjetas de resumen
                    var elTotal = document.getElementById('total-reports');
                    var elMonth = document.getElementById('reports-this-month');
                    var elAvg   = document.getElementById('avg-priority');
                    var elRate  = document.getElementById('completion-rate');
                    if (elTotal) elTotal.textContent = totalReports;
                    if (elMonth) elMonth.textContent = reportsThisMonth;
                    if (elAvg)   elAvg.textContent   = avgPriority;
                    if (elRate)  elRate.textContent   = completionRate + '%';

                    createInspectionTypesChart(reports);
                    createMonthlyReportsChart(reports);

                } catch (err) {
                    console.error('Error in loadEstadisticas:', err);
                }
            }

            // ‚îÄ‚îÄ Gr√°fico de Tipos de Inspecci√≥n (barras horizontales) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function createInspectionTypesChart(reports) {
                const container = document.getElementById('inspection-types-chart');
                if (!container) return;

                const types = {};
                reports.forEach(function(r) {
                    if (Array.isArray(r.tipo_inspeccion)) {
                        r.tipo_inspeccion.forEach(function(t){ types[t] = (types[t] || 0) + 1; });
                    } else if (r.tipo_inspeccion && typeof r.tipo_inspeccion === 'string') {
                        types[r.tipo_inspeccion] = (types[r.tipo_inspeccion] || 0) + 1;
                    }
                });

                const entries = Object.entries(types).sort(function(a,b){ return b[1]-a[1]; });
                if (entries.length === 0) {
                    container.innerHTML = '<p style="color:#6b7280;text-align:center;padding:30px">Sin datos de tipo de inspecci√≥n a√∫n.</p>';
                    return;
                }

                const maxVal = entries[0][1];
                const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#ec4899'];

                let html = '<div style="padding:10px 0;">';
                entries.forEach(function([type, count], i) {
                    const pct = maxVal > 0 ? Math.round((count / maxVal) * 100) : 0;
                    const color = colors[i % colors.length];
                    const totalPct = reports.length > 0 ? Math.round((count / reports.length) * 100) : 0;
                    html += '<div style="margin-bottom:14px;">' +
                        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">' +
                            '<span style="font-size:13px;font-weight:600;color:#1f2937;max-width:65%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + type + '</span>' +
                            '<span style="font-size:13px;color:#6b7280;">' + count + ' (' + totalPct + '%)</span>' +
                        '</div>' +
                        '<div style="background:#e5e7eb;border-radius:6px;height:14px;overflow:hidden;">' +
                            '<div style="height:100%;width:' + pct + '%;background:' + color + ';border-radius:6px;transition:width 0.6s ease;"></div>' +
                        '</div>' +
                    '</div>';
                });
                html += '</div>';
                container.innerHTML = html;
            }

            // ‚îÄ‚îÄ Gr√°fico de Reportes por Mes (barras verticales) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            function createMonthlyReportsChart(reports) {
                const container = document.getElementById('monthly-reports-chart');
                if (!container) return;

                const monthlyData = {};
                const monthNames = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
                reports.forEach(function(r) {
                    const d = new Date(r.created_at);
                    const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
                    monthlyData[key] = { count: (monthlyData[key] ? monthlyData[key].count : 0) + 1, label: monthNames[d.getMonth()] + ' ' + String(d.getFullYear()).slice(2) };
                });

                const entries = Object.entries(monthlyData).sort(function(a,b){ return a[0].localeCompare(b[0]); }).slice(-8);
                if (entries.length === 0) {
                    container.innerHTML = '<p style="color:#6b7280;text-align:center;padding:30px">Sin reportes registrados a√∫n.</p>';
                    return;
                }

                const maxVal = Math.max.apply(null, entries.map(function(e){ return e[1].count; }));
                const BAR_H = 160; // px altura m√°xima barra

                let html = '<div style="display:flex;align-items:flex-end;gap:8px;padding:10px 0 0;overflow-x:auto;">';
                entries.forEach(function([key, info]) {
                    const barH = maxVal > 0 ? Math.max(Math.round((info.count / maxVal) * BAR_H), 18) : 18;
                    html += '<div style="flex:1;min-width:48px;display:flex;flex-direction:column;align-items:center;gap:4px;">' +
                        '<span style="font-size:12px;font-weight:700;color:#1f2937;">' + info.count + '</span>' +
                        '<div style="width:100%;height:' + barH + 'px;background:linear-gradient(180deg,#3b82f6,#1d4ed8);border-radius:6px 6px 0 0;"></div>' +
                        '<span style="font-size:11px;color:#6b7280;white-space:nowrap;">' + info.label + '</span>' +
                    '</div>';
                });
                html += '</div>';
                container.innerHTML = html;
            }

            // Event listener para el bot√≥n de actualizar estad√≠sticas
            document.getElementById('refresh-estadisticas-btn')?.addEventListener('click', loadEstadisticas);
        })();
    </script>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SOPORTE OFFLINE: IndexedDB + Sincronizaci√≥n autom√°tica
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
    (function () {
        'use strict';

        /* ‚îÄ‚îÄ 1. IndexedDB helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        var DB_NAME    = 'mhr-offline-db';
        var DB_VERSION = 1;
        var STORE_NAME = 'pending-reports';

        function openOfflineDB() {
            return new Promise(function (resolve, reject) {
                var req = indexedDB.open(DB_NAME, DB_VERSION);
                req.onupgradeneeded = function (e) {
                    var db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        var store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('synced', 'synced', { unique: false });
                    }
                };
                req.onsuccess  = function (e) { resolve(e.target.result); };
                req.onerror    = function (e) { reject(e.target.error); };
            });
        }

        function savePendingReport(data) {
            return openOfflineDB().then(function (db) {
                return new Promise(function (resolve, reject) {
                    var tx    = db.transaction(STORE_NAME, 'readwrite');
                    var store = tx.objectStore(STORE_NAME);
                    var req   = store.add(Object.assign({ synced: false, timestamp: Date.now() }, data));
                    req.onsuccess = function () { resolve(req.result); };
                    req.onerror   = function () { reject(req.error); };
                });
            });
        }

        function getPendingReports() {
            return openOfflineDB().then(function (db) {
                return new Promise(function (resolve, reject) {
                    var tx    = db.transaction(STORE_NAME, 'readonly');
                    var store = tx.objectStore(STORE_NAME);
                    var index = store.index('synced');
                    var req   = index.getAll(false);
                    req.onsuccess = function () { resolve(req.result); };
                    req.onerror   = function () { reject(req.error); };
                });
            });
        }

        function markReportSynced(id) {
            return openOfflineDB().then(function (db) {
                return new Promise(function (resolve, reject) {
                    var tx     = db.transaction(STORE_NAME, 'readwrite');
                    var store  = tx.objectStore(STORE_NAME);
                    var getReq = store.get(id);
                    getReq.onsuccess = function () {
                        var record = getReq.result;
                        if (record) {
                            record.synced = true;
                            var putReq    = store.put(record);
                            putReq.onsuccess = function () { resolve(); };
                            putReq.onerror   = function () { reject(putReq.error); };
                        } else { resolve(); }
                    };
                    getReq.onerror = function () { reject(getReq.error); };
                });
            });
        }

        /* ‚îÄ‚îÄ 2. Banner helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        function showOfflineBanner(msg, type) {
            var banner = document.getElementById('offline-banner');
            if (!banner) return;
            banner.textContent = msg;
            banner.className   = '';
            banner.classList.add(type || 'offline');
            banner.style.display = 'block';
        }

        function hideOfflineBanner() {
            var banner = document.getElementById('offline-banner');
            if (banner) banner.style.display = 'none';
        }

        window.updatePendingBadge = function () {
            getPendingReports().then(function (list) {
                var badge = document.getElementById('pending-badge');
                if (!badge) return;
                if (list && list.length > 0) {
                    badge.textContent    = list.length + ' reporte' + (list.length > 1 ? 's' : '') + ' pendiente' + (list.length > 1 ? 's' : '');
                    badge.style.display  = 'inline-block';
                } else {
                    badge.style.display  = 'none';
                }
            }).catch(function () {});
        };

        /* ‚îÄ‚îÄ 3. Colectar estado del formulario ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        function collectFormState() {
            function pad(n) { return n.toString().padStart(2, '0'); }

            var fechaEl  = document.getElementById('report-date');
            var fecha    = fechaEl ? fechaEl.textContent.replace(/\s*\(.*\)\s*$/, '').trim() : '';

            var autor = '';
            var authorSel = document.getElementById('report-authors-select');
            if (authorSel) {
                var opt = authorSel.options[authorSel.selectedIndex];
                autor   = opt ? (opt.text || opt.value) : authorSel.value;
            }

            var cargo  = '';
            var roleEl = document.getElementById('report-role');
            if (roleEl) {
                var selOpt = roleEl.options[roleEl.selectedIndex];
                cargo = selOpt ? (selOpt.text || selOpt.value) : roleEl.value;
                if (selOpt && (selOpt.value === 'Otro' || (selOpt.text || '').toLowerCase().indexOf('otro') !== -1)) {
                    var other = document.getElementById('report-role-other');
                    if (other && other.value.trim()) cargo = other.value.trim();
                }
            }

            var tipos = Array.prototype.slice.call(document.querySelectorAll('input[name="tipo_inspeccion"]'))
                .filter(function (i) { return i.checked; })
                .map(function (i) {
                    var lbl = document.querySelector('label[for="' + i.id + '"]');
                    return (lbl ? lbl.textContent.trim() : (i.value || '')).trim();
                }).filter(Boolean);
            var tiposText = tipos.length ? tipos.join(', ') : '-';

            var turnoEl   = document.querySelector('input[name="turno"]:checked');
            var turnoText = '-';
            if (turnoEl) {
                var turnoLbl = document.querySelector('label[for="' + turnoEl.id + '"]');
                turnoText    = turnoLbl ? turnoLbl.textContent.trim() : (turnoEl.value || '-');
            }

            var now        = new Date();
            var folio      = now.getUTCFullYear() + pad(now.getUTCMonth() + 1) + pad(now.getUTCDate()) +
                             '-' + pad(now.getUTCHours()) + pad(now.getUTCMinutes()) + pad(now.getUTCSeconds());
            var utcTimeStr = pad(now.getUTCHours()) + ':' + pad(now.getUTCMinutes()) + ':' + pad(now.getUTCSeconds()) + ' UTC';
            var utcDateStr = pad(now.getUTCDate()) + '/' + pad(now.getUTCMonth() + 1) + '/' + now.getUTCFullYear();

            var items  = Array.prototype.slice.call(document.querySelectorAll('input[type="checkbox"][id^="tipo_"]'));
            var filled = [];
            items.forEach(function (chk) {
                if (!chk.checked) return;
                var id   = chk.id;
                var lbl  = document.querySelector('label[for="' + id + '"]');
                var name = lbl ? lbl.textContent.trim() : id;
                var det  = document.getElementById('details_' + id);
                var fields = [];
                if (det) {
                    Array.prototype.slice.call(det.querySelectorAll('input, textarea, select')).forEach(function (el) {
                        var val = '';
                        if (el.type === 'checkbox' || el.type === 'radio') {
                            if (!el.checked) return;
                            val = el.value || 'Seleccionado';
                        } else {
                            val = (el.value || '').toString().trim();
                        }
                        if (val === '') return;
                        var parentLabel = el.closest('label');
                        var key = parentLabel ? (parentLabel.childNodes[0] ? parentLabel.childNodes[0].textContent.trim() : '') : '';
                        if (!key) key = el.name || el.id;
                        try { key = key.replace(/[:Ôºö]\s*$/, '').trim(); } catch(e) {}
                        fields.push({ key: key, value: val });
                    });
                }
                filled.push({ id: id, name: name, fields: fields });
            });

            // Fotos: guardar como dataURL para poder re-subirlas al sincronizar
            var photos = {};
            if (window.itemPhotos) {
                Object.keys(window.itemPhotos).forEach(function (itemId) {
                    photos[itemId] = (window.itemPhotos[itemId] || []).map(function (p) {
                        return { dataURL: p.dataURL, name: p.name || ('foto_' + Date.now() + '.jpg') };
                    });
                });
            }

            return {
                folio: folio, fecha: fecha, autor: autor, cargo: cargo,
                tiposText: tiposText, turnoText: turnoText,
                utcDateStr: utcDateStr, utcTimeStr: utcTimeStr,
                filled: filled, photos: photos
            };
        }

        /* ‚îÄ‚îÄ 4. Guardar offline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        window.saveFormOffline = function () {
            var data = collectFormState();
            if (!data.filled || data.filled.length === 0) {
                alert('No hay √≠tems seleccionados para guardar.');
                return;
            }
            savePendingReport(data).then(function () {
                window.updatePendingBadge();
                showOfflineBanner('üì• Sin conexi√≥n ‚Äî reporte guardado localmente (se sincronizar√° al reconectarse)', 'pending');
                alert('Reporte guardado localmente.\nCuando te conectes a Internet se subir√° autom√°ticamente.');
            }).catch(function (err) {
                console.error('Error guardando offline:', err);
                alert('No se pudo guardar localmente: ' + (err && err.message ? err.message : err));
            });
        };

        /* ‚îÄ‚îÄ 5. Subir un reporte pendiente a Supabase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        async function uploadPendingReport(record) {
            var sc = window.supabaseClient;
            if (!sc) throw new Error('Supabase no inicializado');

            var { data: { session } } = await sc.auth.getSession();
            if (!session) throw new Error('Sin sesi√≥n activa');
            var userId = session.user.id;

            // 5a. Insertar en tabla reports (sin PDF ‚Äî generado despu√©s si se necesita)
            var reportPayload = {
                folio:           record.folio,
                fecha_local:     record.fecha,
                fecha_utc:       record.utcDateStr + ' ' + record.utcTimeStr,
                tipo_inspeccion: record.tiposText,
                turno:           record.turnoText,
                responsable:     record.autor,
                cargo:           record.cargo,
                user_id:         userId,
                pdf_url:         null
            };
            var { data: reportData, error: reportError } = await sc.from('reports').insert([reportPayload]).select().single();
            if (reportError) throw reportError;
            var reportId = reportData.id;

            // 5b. Insertar items
            if (record.filled && record.filled.length > 0) {
                var itemsPayload = record.filled.map(function (it) {
                    return {
                        report_id: reportId,
                        item_id:   it.id,
                        item_name: it.name,
                        fields:    JSON.stringify(it.fields)
                    };
                });
                var { error: itemsError } = await sc.from('report_items').insert(itemsPayload);
                if (itemsError) console.warn('Error insertando items offline:', itemsError);
            }

            // 5c. Subir fotos
            var photos = record.photos || {};
            for (var itemId in photos) {
                var photoList = photos[itemId];
                for (var pi = 0; pi < photoList.length; pi++) {
                    try {
                        var ph      = photoList[pi];
                        var arr     = ph.dataURL.split(',');
                        var mime    = (arr[0].match(/:(.*?);/) || [, 'image/jpeg'])[1];
                        var bstr    = atob(arr[1]);
                        var byteArr = new Uint8Array(bstr.length);
                        for (var bi = 0; bi < bstr.length; bi++) byteArr[bi] = bstr.charCodeAt(bi);
                        var blob     = new Blob([byteArr], { type: mime });
                        var ext      = (ph.name || 'foto.jpg').split('.').pop() || 'jpg';
                        var fileName = reportId + '/' + itemId + '_' + Date.now() + '_' + pi + '.' + ext;
                        var { error: upError } = await sc.storage.from('photos').upload(fileName, blob, { upsert: false, contentType: mime });
                        if (upError) { console.warn('Error subiendo foto:', upError); continue; }
                        var { data: urlData } = sc.storage.from('photos').getPublicUrl(fileName);
                        var photoUrl = urlData ? urlData.publicUrl : null;
                        if (photoUrl) {
                            await sc.from('item_photos').insert([{
                                report_id:  reportId,
                                item_id:    itemId,
                                photo_url:  photoUrl,
                                photo_name: ph.name
                            }]);
                        }
                    } catch (photoErr) {
                        console.warn('Error procesando foto offline:', photoErr);
                    }
                }
            }

            return reportId;
        }

        /* ‚îÄ‚îÄ 6. Sincronizar todos los reportes pendientes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        window.syncPendingReports = async function () {
            if (!navigator.onLine) return;
            var sc = window.supabaseClient;
            if (!sc) return;
            try {
                var { data: { session } } = await sc.auth.getSession();
                if (!session) return;
            } catch (e) { return; }

            var pending;
            try { pending = await getPendingReports(); } catch (e) { return; }
            if (!pending || pending.length === 0) {
                hideOfflineBanner();
                window.updatePendingBadge();
                return;
            }

            showOfflineBanner('üîÑ Sincronizando ' + pending.length + ' reporte(s)‚Ä¶', 'syncing');

            var successCount = 0;
            for (var i = 0; i < pending.length; i++) {
                try {
                    await uploadPendingReport(pending[i]);
                    await markReportSynced(pending[i].id);
                    successCount++;
                } catch (err) {
                    console.error('Error sincronizando reporte id=' + pending[i].id, err);
                }
            }

            window.updatePendingBadge();

            if (successCount === pending.length) {
                showOfflineBanner('‚úÖ ' + successCount + ' reporte(s) sincronizado(s) correctamente', 'synced');
                setTimeout(hideOfflineBanner, 4000);
            } else {
                var failed = pending.length - successCount;
                showOfflineBanner('‚ö†Ô∏è ' + successCount + ' sincronizado(s), ' + failed + ' con error', 'pending');
            }
        };

        /* ‚îÄ‚îÄ 7. Listeners de conectividad e inicializaci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        window.addEventListener('online', function () {
            hideOfflineBanner();
            window.syncPendingReports();
        });

        window.addEventListener('offline', function () {
            showOfflineBanner('üì° Sin conexi√≥n a Internet', 'offline');
        });

        document.addEventListener('DOMContentLoaded', function () {
            if (!navigator.onLine) {
                showOfflineBanner('üì° Sin conexi√≥n ‚Äî los reportes se guardar√°n localmente', 'offline');
            }
            window.updatePendingBadge();
            // Si hay pendientes y hay conexi√≥n, sincronizar autom√°ticamente al abrir
            if (navigator.onLine) {
                getPendingReports().then(function (list) {
                    if (list && list.length > 0) {
                        // Esperar 0.8 s para que Supabase termine de inicializarse
                        setTimeout(window.syncPendingReports, 800);
                    }
                }).catch(function () {});
            }
        });

    })();
    </script>
</body>

</html>